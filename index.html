<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Helper School App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  direction: rtl;
  text-align: center;
  background: #f7f7f7;
  overflow: hidden; /* disable scrolling */
}

body {
  display: flex;
  justify-content: center;
  align-items: stretch;
}

.container {
  flex: 1;
  max-width: 100%;
  margin: 0;
  padding: 20px;
  box-sizing: border-box;
  overflow-y: auto; /* allow scrolling inside container */
  background: white;
  display: flex;
  flex-direction: column;
}

h2 { font-size: 3rem; margin-bottom: 20px; }
h3 { font-size: 2.2rem; margin-bottom: 15px; }
h4 { font-size: 1.8rem; margin-bottom: 10px; }

button {
  padding: 18px 35px;
  margin: 10px 5px;
  border: none;
  background: #1976d2;
  color: white;
  border-radius: 10px;
  cursor: pointer;
  font-size: 2rem;
  transition: background 0.3s;
}

button:hover { background: #1565c0; }

.hidden { display: none; }

input, textarea, select {
  width: 95%;
  padding: 18px;
  margin: 8px 0;
  font-size: 1.8rem;
  box-sizing: border-box;
}

/* uploaded image preview restricted */
img#preview {
  max-width: 200px;
  max-height: 200px;
  margin: 15px 0;
  height: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
}

img { max-width: 100%; margin: 15px 0; height: auto; }

.note, .event, .social {
  border: 1px solid #ddd;
  padding: 18px;
  margin: 12px 0;
  border-radius: 10px;
  text-align: right;
  word-wrap: break-word;
  font-size: 1.8rem;
}

label {
  font-weight: bold;
  margin-top: 10px;
  display: block;
  text-align: right;
  font-size: 1.6rem;
}

#cancelImageBtn {
  background: #d32f2f;
}
#cancelImageBtn:hover { background: #b71c1c; }

@media (max-width: 480px) {
  .container { padding: 15px; }
  h2 { font-size: 2.6rem; }
  h3 { font-size: 2rem; }
  h4 { font-size: 1.6rem; }
  button { width: 100%; padding: 22px; font-size: 2rem; }
  input, textarea, select { padding: 16px; font-size: 1.6rem; }
  .note, .event, .social { font-size: 1.6rem; padding: 16px; }
}
</style>
</head>
<body>
<div class="container">
<h2>📚 אפליקציית בית ספר</h2>

<div id="view-grades">
  <h3>בחר שכבת גיל</h3>
  <button onclick="openGrade('ז')">ז</button>
  <button onclick="openGrade('ח')">ח</button>
  <button onclick="openGrade('ט')">ט</button>
</div>

<div id="view-subjects" class="hidden">
  <h3 id="subject-title"></h3>
  <div id="subject-list"></div>
  <h3>📂 קטגוריות נוספות</h3>
  <div id="category-list"></div>
  <button onclick="backToGrades()">⬅ חזרה</button>
</div>

<div id="view-form" class="hidden">
  <h3 id="form-title"></h3>
  <input type="text" id="comment" placeholder="שם התלמיד"><br>
  <textarea id="description" placeholder="תיאור"></textarea><br>
  <input type="file" id="imageInput"><br>
  <button id="cancelImageBtn" class="hidden" onclick="cancelImage()">❌ בטל תמונה</button><br>
  <img id="preview" class="hidden"><br>
  <button onclick="saveSubject()">💾 שמור</button>
  <button onclick="backToSubjects()">⬅ חזרה</button>
  <h3>📌 הערות שמורות</h3>
  <div id="notes-list"></div>
</div>

<div id="view-sport-events" class="hidden">
  <h3>ספורט - תזמון אירועים</h3>
  <select id="sport-event-select">
    <option value="כדורגל">כדורגל</option>
    <option value="כדורסל">כדורסל</option>
    <option value="ריצה">ריצה</option>
  </select><br>
  <label for="sport-date">תאריך:</label>
  <input type="date" id="sport-date"><br>
  <label for="sport-time">שעה:</label>
  <input type="time" id="sport-time"><br>
  <button onclick="saveSportEvent()">💾 שמור אירוע</button>
  <button onclick="backToSubjects()">⬅ חזרה</button>
  <h3>📌 אירועים שמורים</h3>
  <div id="sport-events-list"></div>
</div>

<div id="view-social-meeting" class="hidden">
  <h3>מפגש חברתי</h3>
  <div id="social-locations">
    <button onclick="selectSocialLocation('חדר אוכל')">חדר אוכל</button>
    <button onclick="selectSocialLocation('חצר')">חצר</button>
    <button onclick="selectSocialLocation('ספריה')">ספריה</button>
    <button onclick="selectSocialLocation('אולם ספורט')">אולם ספורט</button>
    <button onclick="selectSocialLocation('כיתת מחשבים')">כיתת מחשבים</button>
    <button onclick="selectSocialLocation('גן משחקים')">גן משחקים</button>
  </div>
  <div id="social-datetime" class="hidden">
    <h4 id="selected-location"></h4>
    <label for="social-date">תאריך:</label>
    <input type="date" id="social-date"><br>
    <label for="social-time">שעה:</label>
    <input type="time" id="social-time"><br>
    <button onclick="saveSocialMeeting()">💾 שמור מפגש</button>
  </div>
  <button onclick="backToSubjects()">⬅ חזרה</button>
  <h3>📌 מפגשים שמורים</h3>
  <div id="social-meetings-list"></div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA8JW7C-tvAw1E-2rNthoI9yG-C4zjWjM4",
  authDomain: "helper-a6ca2.firebaseapp.com",
  projectId: "helper-a6ca2",
  storageBucket: "helper-a6ca2.appspot.com",
  messagingSenderId: "710212458048",
  appId: "1:710212458048:web:bf0726a7f5cbf25c9b71a5",
  measurementId: "G-T5YL5RC934"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const defaultSubjects = ["מדעים","ערבית","היסטוריה","מתמטיקה","אנגלית","גאוגרפיה","שפה"];
const extraCategories = ["מפגש חברתי","ספורט","הצעות לשיפור או בקשות"];

let currentGrade = null;
let currentSubject = null;
let selectedFile = null;
let unsubscribe = null;
let selectedSocialLocation = null;

// Functions
function openGrade(grade) {
  currentGrade = grade;
  document.getElementById("view-grades").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
  document.getElementById("subject-title").innerText = "מקצועות בשכבת " + grade;

  const subjectList = document.getElementById("subject-list");
  subjectList.innerHTML = "";
  defaultSubjects.forEach(sub => {
    const btn = document.createElement("button");
    btn.innerText = sub;
    btn.onclick = () => openForm(sub);
    subjectList.appendChild(btn);
  });

  const catList = document.getElementById("category-list");
  catList.innerHTML = "";
  extraCategories.forEach(cat => {
    const btn = document.createElement("button");
    btn.innerText = cat;
    if(cat === "ספורט") btn.onclick = openSportEvents;
    else if(cat === "מפגש חברתי") btn.onclick = openSocialMeeting;
    else btn.onclick = () => openForm(cat);
    catList.appendChild(btn);
  });
}

function backToGrades() {
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("view-grades").classList.remove("hidden");
}

function backToSubjects() {
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("social-datetime").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
}

// IMAGE UPLOAD
document.getElementById("imageInput").addEventListener("change", e => {
  selectedFile = e.target.files[0];
  const cancelBtn = document.getElementById("cancelImageBtn");
  const preview = document.getElementById("preview");

  if(selectedFile){
    cancelBtn.classList.remove("hidden");
    const reader = new FileReader();
    reader.onload = e2 => {
      preview.src = e2.target.result;
      preview.classList.remove("hidden");
    };
    reader.readAsDataURL(selectedFile);
  } else cancelImage();
});

function cancelImage(){
  selectedFile = null;
  const input = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  input.value = "";
  preview.src = "";
  preview.classList.add("hidden");
  document.getElementById("cancelImageBtn").classList.add("hidden");
}

function openForm(subject) {
  currentSubject = subject;
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.remove("hidden");
  document.getElementById("form-title").innerText = "הוספת הערה ל: " + subject;
  document.getElementById("comment").value = "";
  document.getElementById("description").value = "";
  cancelImage();
  loadNotes();
}

async function saveSubject() {
  const comment = document.getElementById("comment").value.trim();
  const description = document.getElementById("description").value.trim();
  if(!comment || !description){ alert("אנא מלא את כל השדות"); return; }

  try {
    let imageUrl = "";
    if(selectedFile){
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`${currentGrade}/${currentSubject}/${Date.now()}-${selectedFile.name}`);
      await fileRef.put(selectedFile);
      imageUrl = await fileRef.getDownloadURL();
    }

    const subjectRef = db.collection("grades").doc(currentGrade)
                         .collection("subjects").doc(currentSubject);
    await subjectRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    await subjectRef.collection("comments").add({
      comment,
      description,
      imageUrl: imageUrl || "",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("נשמר בהצלחה!");
    backToGrades();
  } catch(err){
    console.error("Upload error:", err);
    alert("שגיאה בשמירה: "+err.message);
  }
}

function loadNotes() {
  const list = document.getElementById("notes-list");
  list.innerHTML = "";
  const ref = db.collection("grades").doc(currentGrade)
    .collection("subjects").doc(currentSubject)
    .collection("comments").orderBy("timestamp","desc");

  unsubscribe = ref.onSnapshot(snapshot=>{
    list.innerHTML="";
    snapshot.forEach(doc=>{
      const note = doc.data();
      const div = document.createElement("div");
      div.className="note";
      div.innerHTML=`<h4>${note.comment}</h4><p>${note.description}</p>`+
                    (note.imageUrl ? `<img src="${note.imageUrl}">` : "");
      list.appendChild(div);
    });
  });
}

// SPORT EVENTS
function openSportEvents(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-sport-events").classList.remove("hidden");
  loadSportEvents();
}

function saveSportEvent(){
  const eventName = document.getElementById("sport-event-select").value;
  const date = document.getElementById("sport-date").value;
  const time = document.getElementById("sport-time").value;
  if(!date || !time){ alert("אנא בחר תאריך ושעה"); return; }
  db.collection("grades").doc(currentGrade)
    .collection("sport_events").add({
      name: eventName,
      date,
      time,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>loadSportEvents());
}

function loadSportEvents(){
  const list = document.getElementById("sport-events-list");
  list.innerHTML = "";
  db.collection("grades").doc(currentGrade)
    .collection("sport_events").orderBy("timestamp","desc")
    .get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const e = doc.data();
        const div = document.createElement("div");
        div.className = "event";
        div.innerText = `${e.name} - ${e.date} ${e.time}`;
        list.appendChild(div);
      });
    });
}

// SOCIAL MEETINGS
function openSocialMeeting(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.remove("hidden");
  loadSocialMeetings();
}

function selectSocialLocation(loc){
  selectedSocialLocation = loc;
  document.getElementById("selected-location").innerText = loc;
  document.getElementById("social-datetime").classList.remove("hidden");
}

function saveSocialMeeting(){
  const date = document.getElementById("social-date").value;
  const time = document.getElementById("social-time").value;
  if(!selectedSocialLocation || !date || !time){ alert("אנא מלא מיקום, תאריך ושעה"); return; }
  db.collection("grades").doc(currentGrade)
    .collection("social_meetings").add({
      location: selectedSocialLocation,
      date,
      time,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{ alert("מפגש נשמר!"); loadSocialMeetings(); });
}

function loadSocialMeetings(){
  const list = document.getElementById("social-meetings-list");
  list.innerHTML = "";
  db.collection("grades").doc(currentGrade)
    .collection("social_meetings").orderBy("timestamp","desc")
    .get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const m = doc.data();
        const div = document.createElement("div");
        div.className = "social";
        div.innerText = `${m.location} - ${m.date} ${m.time}`;
        list.appendChild(div);
      });
    });
}
</script>
</body>
</html>
