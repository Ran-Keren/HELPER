<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Helper School App</title>
<style>
body { font-family: Arial, sans-serif; direction: rtl; text-align: center; background: #f7f7f7; }
.container { margin: 20px auto; max-width: 600px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
button { padding: 10px 20px; margin: 5px; border: none; background: #1976d2; color: white; border-radius: 5px; cursor: pointer; }
button:hover { background: #1565c0; }
.hidden { display: none; }
input, textarea, select { width: 90%; padding: 8px; margin: 5px 0; }
img { max-width: 150px; margin: 10px 0; }
.note { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: right; }
</style>
</head>
<body>
<div class="container">
<h2>ğŸ“š ××¤×œ×™×§×¦×™×™×ª ×‘×™×ª ×¡×¤×¨</h2>

<div id="view-grades">
  <h3>×‘×—×¨ ×©×›×‘×ª ×’×™×œ</h3>
  <button onclick="openGrade('×–')">×–</button>
  <button onclick="openGrade('×—')">×—</button>
  <button onclick="openGrade('×˜')">×˜</button>
</div>

<div id="view-subjects" class="hidden">
  <h3 id="subject-title"></h3>
  <div id="subject-list"></div>
  <h3>ğŸ“‚ ×§×˜×’×•×¨×™×•×ª × ×•×¡×¤×•×ª</h3>
  <div id="category-list"></div>
  <button onclick="backToGrades()">â¬… ×—×–×¨×”</button>
</div>

<div id="view-form" class="hidden">
  <h3 id="form-title"></h3>
  <input type="text" id="comment" placeholder="×©× ×”×ª×œ××™×“"><br>
  <textarea id="description" placeholder="×ª×™××•×¨"></textarea><br>
  <input type="file" id="imageInput"><br>
  <img id="preview" class="hidden"><br>
  <button onclick="saveSubject()">ğŸ’¾ ×©××•×¨</button>
  <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
  <h3>ğŸ“Œ ×”×¢×¨×•×ª ×©××•×¨×•×ª</h3>
  <div id="notes-list"></div>
</div>

<div id="view-sport-events" class="hidden">
  <h3>×¡×¤×•×¨×˜ - ×ª×–××•×Ÿ ××™×¨×•×¢×™×</h3>
  <select id="sport-event-select">
    <option value="×›×“×•×¨×’×œ">×›×“×•×¨×’×œ</option>
    <option value="×›×“×•×¨×¡×œ">×›×“×•×¨×¡×œ</option>
    <option value="×¨×™×¦×”">×¨×™×¦×”</option>
  </select><br>
  <input type="date" id="sport-date"><br>
  <input type="time" id="sport-time"><br>
  <button onclick="saveSportEvent()">ğŸ’¾ ×©××•×¨ ××™×¨×•×¢</button>
  <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
</div>

<div id="view-social-meeting" class="hidden">
  <h3>××¤×’×© ×—×‘×¨×ª×™</h3>
  <button onclick="addSocialMeeting('××™×§×•×')">×‘×—×¨ ××™×§×•×</button>
  <button onclick="addSocialMeeting('×–××Ÿ')">×‘×—×¨ ×–××Ÿ</button>
  <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA8JW7C-tvAw1E-2rNthoI9yG-C4zjWjM4",
  authDomain: "helper-a6ca2.firebaseapp.com",
  projectId: "helper-a6ca2",
  storageBucket: "helper-a6ca2.appspot.com",
  messagingSenderId: "710212458048",
  appId: "1:710212458048:web:bf0726a7f5cbf25c9b71a5",
  measurementId: "G-T5YL5RC934"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const defaultSubjects = ["××“×¢×™×","×¢×¨×‘×™×ª","×”×™×¡×˜×•×¨×™×”","××ª××˜×™×§×”","×× ×’×œ×™×ª","×’××•×’×¨×¤×™×”","×©×¤×”"];
const extraCategories = ["××¤×’×© ×—×‘×¨×ª×™","×¡×¤×•×¨×˜","×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ××• ×‘×§×©×•×ª"];

let currentGrade = null;
let currentSubject = null;
let selectedFile = null;
let unsubscribe = null;

function openGrade(grade) {
  currentGrade = grade;
  document.getElementById("view-grades").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
  document.getElementById("subject-title").innerText = "××§×¦×•×¢×•×ª ×‘×©×›×‘×ª " + grade;

  const subjectList = document.getElementById("subject-list");
  subjectList.innerHTML = "";
  defaultSubjects.forEach(sub => {
    const btn = document.createElement("button");
    btn.innerText = sub;
    btn.onclick = () => openForm(sub);
    subjectList.appendChild(btn);
  });

  const catList = document.getElementById("category-list");
  catList.innerHTML = "";
  extraCategories.forEach(cat => {
    const btn = document.createElement("button");
    btn.innerText = cat;
    if(cat === "×¡×¤×•×¨×˜") btn.onclick = openSportEvents;
    else if(cat === "××¤×’×© ×—×‘×¨×ª×™") btn.onclick = openSocialMeeting;
    else btn.onclick = () => openForm(cat);
    catList.appendChild(btn);
  });
}

function backToGrades() {
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("view-grades").classList.remove("hidden");
}

function backToSubjects() {
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
}

document.getElementById("imageInput").addEventListener("change", e => {
  selectedFile = e.target.files[0];
  if(selectedFile){
    const reader = new FileReader();
    reader.onload = e2 => {
      const img = document.getElementById("preview");
      img.src = e2.target.result;
      img.classList.remove("hidden");
    };
    reader.readAsDataURL(selectedFile);
  }
});

function openForm(subject) {
  currentSubject = subject;
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.remove("hidden");
  document.getElementById("form-title").innerText = "×”×•×¡×¤×ª ×”×¢×¨×” ×œ: " + subject;

  document.getElementById("comment").value = "";
  document.getElementById("description").value = "";
  document.getElementById("imageInput").value = "";
  document.getElementById("preview").classList.add("hidden");
  selectedFile = null;
  loadNotes();
}

async function saveSubject() {
  const comment = document.getElementById("comment").value.trim();
  const description = document.getElementById("description").value.trim();
  if(!comment || !description){ alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }

  try {
    let imageUrl = "";
    if(selectedFile){
      const ref = storage.ref(`${currentGrade}/${currentSubject}/${Date.now()}-${selectedFile.name}`);
      await ref.put(selectedFile);
      imageUrl = await ref.getDownloadURL();
    }

    const subjectRef = db.collection("grades").doc(currentGrade)
                         .collection("subjects").doc(currentSubject);
    await subjectRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    await subjectRef.collection("comments").add({
      comment,
      description,
      imageUrl: imageUrl || "",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
    document.getElementById("view-form").classList.add("hidden");
    backToGrades();
  } catch(err){
    console.error(err);
    alert("×©×’×™××” ×‘×©××™×¨×”: "+err.message);
  }
}

function loadNotes() {
  const list = document.getElementById("notes-list");
  list.innerHTML = "";
  const ref = db.collection("grades").doc(currentGrade)
    .collection("subjects").doc(currentSubject)
    .collection("comments").orderBy("timestamp","desc");

  unsubscribe = ref.onSnapshot(snapshot=>{
    list.innerHTML="";
    snapshot.forEach(doc=>{
      const note = doc.data();
      const div = document.createElement("div");
      div.className="note";
      div.innerHTML=`<h4>${note.comment}</h4><p>${note.description}</p>`+
                    (note.imageUrl ? `<img src="${note.imageUrl}">` : "");
      list.appendChild(div);
    });
  });
}

// Sport events with date & time pickers
function openSportEvents(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-sport-events").classList.remove("hidden");
}

function saveSportEvent(){
  const eventName = document.getElementById("sport-event-select").value;
  const date = document.getElementById("sport-date").value;
  const time = document.getElementById("sport-time").value;
  if(!date || !time){ alert("×× × ×‘×—×¨ ×ª××¨×™×š ×•×©×¢×”"); return; }
  db.collection("grades").doc(currentGrade)
    .collection("sport_events").add({
      name: eventName,
      date,
      time,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  alert("××™×¨×•×¢ × ×©××¨!");
}

// Social meeting buttons
function openSocialMeeting(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.remove("hidden");
}

function addSocialMeeting(type){
  const value = prompt(`×”×–×Ÿ ${type} ×œ××¤×’×© ×”×—×‘×¨×ª×™`);
  if(value){
    db.collection("grades").doc(currentGrade)
      .collection("social_meetings").add({
        [type]: value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
  }
}
</script>
</body>
</html>
