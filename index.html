<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Helper School App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Roboto', Arial, sans-serif;
    direction: rtl;
    text-align: center;
    background: #f0f2f5; /* Lighter, modern background */
    overflow: hidden;
}

body {
    display: flex;
    justify-content: center;
    align-items: center;
}

.container {
    flex: 1;
    max-width: 600px; /* Max-width for better readability on large screens */
    height: 100vh;
    margin: 0 auto;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
    background: #ffffff; /* White card-like background */
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Soft shadow */
    border-radius: 12px;
}

h2, h3, h4 {
    font-family: 'Poppins', sans-serif; /* A different font for headings */
    color: #333; /* Darker text color */
    margin: 10px 0;
}

h2 { font-size: 2.2rem; }
h3 { font-size: 1.8rem; }
h4 { font-size: 1.5rem; }

button {
    padding: 12px 24px;
    margin: 8px 4px;
    border: none;
    background: #4a90e2; /* A slightly softer blue */
    color: white;
    border-radius: 25px; /* Fully rounded buttons */
    cursor: pointer;
    font-size: 1.4rem;
    font-weight: bold;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

button:hover {
    background: #357abd; /* Darker blue on hover */
    transform: translateY(-2px); /* Slight lift effect */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.hidden { display: none; }

input, textarea, select {
    width: 90%;
    padding: 12px;
    margin: 8px 0;
    font-size: 1.4rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

input:focus, textarea:focus, select:focus {
    border-color: #4a90e2; /* Highlight on focus */
    outline: none;
}

img#preview, img {
    max-width: 100%;
    max-height: 200px;
    margin: 0px auto;
    height: auto;
    border-radius: 8px;
    border: 0px solid #e0e0e0;
    display: block; /* Center images */
}

.note, .event, .social {
    background: #f9f9f9; /* Off-white background for cards */
    border: 1px solid #e0e0e0;
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    text-align: right;
    word-wrap: break-word;
    font-size: 1.4rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Subtle card shadow */
}

.note p, .event p, .social p {
    margin-top: 5px;
    color: #555; /* Slightly lighter text */
}

.reply {
    margin-right: 25px;
    margin-top: 10px;
    border-right: 4px solid #4a90e2;
    padding-right: 15px;
    font-size: 1.3rem;
    background: #eef5ff; /* Light blue for replies */
    border-radius: 0 8px 8px 0;
}

label {
    font-weight: 600;
    margin-top: 10px;
    display: block;
    text-align: right;
    font-size: 1.2rem;
    color: #444;
}

#cancelImageBtn, #cancelImageBtn:hover {
    background: #e74c3c; /* A strong red for delete actions */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

@media (max-width: 480px) {
    .container {
        padding: 10px;
        box-shadow: none; /* No shadow on mobile */
    }
    h2 { font-size: 1.8rem; }
    h3 { font-size: 1.4rem; }
    h4 { font-size: 1.2rem; }
    button {
        width: 100%;
        padding: 10px;
        font-size: 1.2rem;
        margin: 6px 0;
    }
    input, textarea, select {
        padding: 8px;
        font-size: 1.2rem;
    }
    .note, .event, .social {
        font-size: 1.2rem;
        padding: 10px;
    }
}
</style>
</head>
<body>
<div class="container">

  <div id="view-grades">
    <!-- Logo only on first page -->
    <img src="https://i.imgur.com/rEEphAR.jpeg" alt="" style="max-width:200px; margin:10px auto; display:block;">

    <h3>×‘×—×¨ ×©×›×‘×ª ×’×™×œ</h3>
    <button onclick="openGrade('×–')">×–</button>
    <button onclick="openGrade('×—')">×—</button>
    <button onclick="openGrade('×˜')">×˜</button>
  </div>

  <div id="view-subjects" class="hidden">
    <h3 id="subject-title"></h3>
    <div id="subject-list"></div>
    <h3>ğŸ“‚ ×§×˜×’×•×¨×™×•×ª × ×•×¡×¤×•×ª</h3>
    <div id="category-list"></div>
    <button onclick="backToGrades()">â¬… ×—×–×¨×”</button>
  </div>

  <div id="view-form" class="hidden">
    <h3 id="form-title"></h3>
    <input type="text" id="comment" placeholder="×©× ×”×ª×œ××™×“"><br>
    <textarea id="description" placeholder="×ª×™××•×¨"></textarea><br>
    <input type="file" id="imageInput"><br>
    <button id="cancelImageBtn" class="hidden" onclick="cancelImage()">âŒ ×‘×˜×œ ×ª××•× ×”</button><br>
    <img id="preview" class="hidden"><br>
    <button onclick="saveSubject()">ğŸ’¾ ×©××•×¨</button>
    <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
    <h3>ğŸ“Œ ×”×¢×¨×•×ª ×©××•×¨×•×ª</h3>
    <div id="notes-list"></div>
  </div>

  <div id="view-sport-events" class="hidden">
    <h3>×¡×¤×•×¨×˜ - ×ª×–××•×Ÿ ××™×¨×•×¢×™×</h3>
    <select id="sport-event-select">
      <option value="×›×“×•×¨×’×œ">×›×“×•×¨×’×œ</option>
      <option value="×›×“×•×¨×¡×œ">×›×“×•×¨×¡×œ</option>
      <option value="×¨×™×¦×”">×¨×™×¦×”</option>
    </select><br>
    <label for="sport-date">×ª××¨×™×š:</label>
    <input type="date" id="sport-date"><br>
    <label for="sport-time">×©×¢×”:</label>
    <input type="time" id="sport-time"><br>
    <button onclick="saveSportEvent()">ğŸ’¾ ×©××•×¨ ××™×¨×•×¢</button>
    <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
    <h3>ğŸ“Œ ××™×¨×•×¢×™× ×©××•×¨×™×</h3>
    <div id="sport-events-list"></div>
  </div>

  <div id="view-social-meeting" class="hidden">
    <h3>××¤×’×© ×—×‘×¨×ª×™</h3>
    <div id="social-locations">
      <button onclick="selectSocialLocation('×—×“×¨ ××•×›×œ')">×—×“×¨ ××•×›×œ</button>
      <button onclick="selectSocialLocation('×—×¦×¨')">×—×¦×¨</button>
      <button onclick="selectSocialLocation('×¡×¤×¨×™×”')">×¡×¤×¨×™×”</button>
      <button onclick="selectSocialLocation('××•×œ× ×¡×¤×•×¨×˜')">××•×œ× ×¡×¤×•×¨×˜</button>
      <button onclick="selectSocialLocation('×›×™×ª×ª ××—×©×‘×™×')">×›×™×ª×ª ××—×©×‘×™×</button>
      <button onclick="selectSocialLocation('×’×Ÿ ××©×—×§×™×')">×’×Ÿ ××©×—×§×™×</button>
    </div>
    <div id="social-datetime" class="hidden">
      <h4 id="selected-location"></h4>
      <label for="social-date">×ª××¨×™×š:</label>
      <input type="date" id="social-date"><br>
      <label for="social-time">×©×¢×”:</label>
      <input type="time" id="social-time"><br>
      <button onclick="saveSocialMeeting()">ğŸ’¾ ×©××•×¨ ××¤×’×©</button>
    </div>
    <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
    <h3>ğŸ“Œ ××¤×’×©×™× ×©××•×¨×™×</h3>
    <div id="social-meetings-list"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA8JW7C-tvAw1E-2rNthoI9yG-C4zjWjM4",
  authDomain: "helper-a6ca2.firebaseapp.com",
  projectId: "helper-a6ca2",
  storageBucket: "helper-a6ca2.appspot.com",
  messagingSenderId: "710212458048",
  appId: "1:710212458048:web:bf0726a7f5cbf25c9b71a5",
  measurementId: "G-T5YL5RC934"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const defaultSubjects = ["××“×¢×™×","×¢×¨×‘×™×ª","×”×™×¡×˜×•×¨×™×”","××ª××˜×™×§×”","×× ×’×œ×™×ª","×’××•×’×¨×¤×™×”","×©×¤×”"];
const extraCategories = ["××¤×’×© ×—×‘×¨×ª×™","×¡×¤×•×¨×˜","×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ××• ×‘×§×©×•×ª"];

let currentGrade = null;
let currentSubject = null;
let selectedFile = null;
let unsubscribe = null;
let selectedSocialLocation = null;

// Open grade
function openGrade(grade) {
  currentGrade = grade;
  document.getElementById("view-grades").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
  document.getElementById("subject-title").innerText = "××§×¦×•×¢×•×ª ×‘×©×›×‘×ª " + grade;

  const subjectList = document.getElementById("subject-list");
  subjectList.innerHTML = "";
  defaultSubjects.forEach(sub => {
    const btn = document.createElement("button");
    btn.innerText = sub;
    btn.onclick = () => openForm(sub);
    subjectList.appendChild(btn);
  });

  const catList = document.getElementById("category-list");
  catList.innerHTML = "";
  extraCategories.forEach(cat => {
    const btn = document.createElement("button");
    btn.innerText = cat;
    if(cat === "×¡×¤×•×¨×˜") btn.onclick = openSportEvents;
    else if(cat === "××¤×’×© ×—×‘×¨×ª×™") btn.onclick = openSocialMeeting;
    else btn.onclick = () => openForm(cat);
    catList.appendChild(btn);
  });
}

// Back navigation
function backToGrades() {
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("view-grades").classList.remove("hidden");
}

function backToSubjects() {
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("social-datetime").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
}

// IMAGE UPLOAD
document.getElementById("imageInput").addEventListener("change", e => {
  selectedFile = e.target.files[0];
  const cancelBtn = document.getElementById("cancelImageBtn");
  const preview = document.getElementById("preview");

  if(selectedFile){
    cancelBtn.classList.remove("hidden");
    const reader = new FileReader();
    reader.onload = e2 => {
      preview.src = e2.target.result;
      preview.classList.remove("hidden");
    };
    reader.readAsDataURL(selectedFile);
  } else cancelImage();
});

function cancelImage(){
  selectedFile = null;
  const input = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  input.value = "";
  preview.src = "";
  preview.classList.add("hidden");
  document.getElementById("cancelImageBtn").classList.add("hidden");
}

// Open form
function openForm(subject) {
  currentSubject = subject;
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.remove("hidden");
  document.getElementById("form-title").innerText = "×”×•×¡×¤×ª ×”×¢×¨×” ×œ: " + subject;
  document.getElementById("comment").value = "";
  document.getElementById("description").value = "";
  cancelImage();
  loadNotes();
}

// Save comment
async function saveSubject(parentCommentId = null) {
  const comment = document.getElementById("comment").value.trim();
  const description = document.getElementById("description").value.trim();
  if(!comment || !description){ alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }

  try {
    let imageUrl = "";
    if(selectedFile){
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`${currentGrade}/${currentSubject}/${Date.now()}-${selectedFile.name}`);
      await fileRef.put(selectedFile);
      imageUrl = await fileRef.getDownloadURL();
    }

    const subjectRef = db.collection("grades").doc(currentGrade)
                         .collection("subjects").doc(currentSubject);
    await subjectRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

    if(parentCommentId){
      await subjectRef.collection("comments").doc(parentCommentId)
        .collection("replies").add({
          comment,
          description,
          imageUrl: imageUrl || "",
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } else {
      await subjectRef.collection("comments").add({
        comment,
        description,
        imageUrl: imageUrl || "",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
    document.getElementById("comment").value = "";
    document.getElementById("description").value = "";
    cancelImage();
  } catch(err){
    console.error("Upload error:", err);
    alert("×©×’×™××” ×‘×©××™×¨×”: "+err.message);
  }
}

// Load notes with real-time updates
function loadNotes() {
  const list = document.getElementById("notes-list");
  const ref = db.collection("grades").doc(currentGrade)
    .collection("subjects").doc(currentSubject)
    .collection("comments").orderBy("timestamp","desc");

  if(unsubscribe) unsubscribe();
  unsubscribe = ref.onSnapshot(snapshot=>{
    list.innerHTML="";
    snapshot.forEach(doc=>{
      const note = doc.data();
      const div = document.createElement("div");
      div.className="note";
      div.innerHTML=`<h4>${note.comment}</h4><p>${note.description}</p>`+
                    (note.imageUrl ? `<img src="${note.imageUrl}">` : "");

      // Reply button
      const replyBtn = document.createElement("button");
      replyBtn.innerText = "ğŸ’¬ ×”×©×‘";
      replyBtn.onclick = ()=> {
        const replyComment = prompt("×”×–×Ÿ ××ª ×”×©× ×©×œ×š:");
        const replyDesc = prompt("×›×ª×•×‘ ××ª ×”×”×•×“×¢×” ×©×œ×š:");
        if(replyComment && replyDesc){
          saveSubjectReply(doc.id, replyComment, replyDesc);
        }
      };
      div.appendChild(replyBtn);

      // Delete button
      const deleteBtn = document.createElement("button");
      deleteBtn.innerText = "ğŸ—‘ï¸ ××—×§";
      deleteBtn.style.background = "#d32f2f";
      deleteBtn.style.marginLeft = "0px";
      deleteBtn.onclick = async () => {
        if(confirm("×œ××—×•×§ ×”×¢×¨×” ×–×•?")) {
          await doc.ref.delete();
        }
      };
      div.appendChild(deleteBtn);

      // Load replies in real-time
      doc.ref.collection("replies").orderBy("timestamp","asc").onSnapshot(replySnap=>{
        const oldReplies = div.querySelectorAll(".reply");
        oldReplies.forEach(r => r.remove());
        replySnap.forEach(replyDoc=>{
          const r = replyDoc.data();
          const rDiv = document.createElement("div");
          rDiv.className="reply";
          rDiv.innerHTML=`<strong>${r.comment}</strong><p>${r.description}</p>`+
                         (r.imageUrl ? `<img src="${r.imageUrl}">` : "");

          // Delete reply
          const delReplyBtn = document.createElement("button");
          delReplyBtn.innerText = "ğŸ—‘ï¸ ××—×§";
          delReplyBtn.style.background = "#d32f2f";
          delReplyBtn.style.marginLeft = "4px";
          delReplyBtn.onclick = async () => {
            if(confirm("×œ××—×•×§ ×ª×’×•×‘×” ×–×•?")) {
              await replyDoc.ref.delete();
            }
          };
          rDiv.appendChild(delReplyBtn);

          div.appendChild(rDiv);
        });
      });

      list.appendChild(div);
    });
  });
}

// Save reply
async function saveSubjectReply(parentCommentId, comment, description){
  const subjectRef = db.collection("grades").doc(currentGrade)
                       .collection("subjects").doc(currentSubject);
  await subjectRef.collection("comments").doc(parentCommentId)
    .collection("replies").add({
      comment,
      description,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
}

// SPORT EVENTS
function openSportEvents(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-sport-events").classList.remove("hidden");
  loadSportEvents();
}

function saveSportEvent(){
  const eventName = document.getElementById("sport-event-select").value;
  const date = document.getElementById("sport-date").value;
  const time = document.getElementById("sport-time").value;
  if(!date || !time){ alert("×× × ×‘×—×¨ ×ª××¨×™×š ×•×©×¢×”"); return; }
  db.collection("grades").doc(currentGrade)
    .collection("sport_events").add({
      name: eventName,
      date,
      time,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>loadSportEvents());
}

function loadSportEvents(){
  const list = document.getElementById("sport-events-list");
  list.innerHTML = "";
  db.collection("grades").doc(currentGrade)
    .collection("sport_events").orderBy("timestamp","desc")
    .get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const e = doc.data();
        const div = document.createElement("div");
        div.className="event";
        div.innerText = `${e.name} - ${e.date} ${e.time}`;

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.innerText = "ğŸ—‘ï¸ ××—×§";
        delBtn.style.background = "#d32f2f";
        delBtn.style.marginLeft = "4px";
        delBtn.onclick = async () => {
          if(confirm("×œ××—×•×§ ××™×¨×•×¢ ×–×”?")) {
            await doc.ref.delete();
            loadSportEvents();
          }
        };
        div.appendChild(delBtn);

        list.appendChild(div);
      });
    });
}

// SOCIAL MEETING
function openSocialMeeting(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.remove("hidden");
  document.getElementById("social-datetime").classList.add("hidden");
  loadSocialMeetings();
}

function selectSocialLocation(location){
  selectedSocialLocation = location;
  document.getElementById("selected-location").innerText = location;
  document.getElementById("social-datetime").classList.remove("hidden");
}

function saveSocialMeeting(){
  const date = document.getElementById("social-date").value;
  const time = document.getElementById("social-time").value;
  if(!selectedSocialLocation || !date || !time){ alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }
  db.collection("grades").doc(currentGrade)
    .collection("social_meetings").add({
      location: selectedSocialLocation,
      date,
      time,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=> loadSocialMeetings());
}

function loadSocialMeetings(){
  const list = document.getElementById("social-meetings-list");
  list.innerHTML = "";
  db.collection("grades").doc(currentGrade)
    .collection("social_meetings").orderBy("timestamp","desc")
    .get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const e = doc.data();
        const div = document.createElement("div");
        div.className="social";
        div.innerText = `${e.location} - ${e.date} ${e.time}`;

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.innerText = "ğŸ—‘ï¸ ××—×§";
        delBtn.style.background = "#d32f2f";
        delBtn.style.marginLeft = "4px";
        delBtn.onclick = async () => {
          if(confirm("×œ××—×•×§ ××¤×’×© ×–×”?")) {
            await doc.ref.delete();
            loadSocialMeetings();
          }
        };
        div.appendChild(delBtn);

        list.appendChild(div);
      });
    });
}
</script>
</body>
</html>
