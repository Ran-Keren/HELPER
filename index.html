<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Helper School App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
<style>
/* --- ××©×ª× ×™ ×¦×‘×¢×™× --- */
:root {
    --primary-color: #00796b; /* Teal / ×›×—×•×œ-×™×¨×•×§ ×¨×¢× ×Ÿ */
    --primary-light: #4db6ac;
    --accent-color: #ff9800; /* ×›×ª×•× */
    --background-color: #f0f4f8; /* ×¨×§×¢ ×‘×”×™×¨ */
    --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --danger-color: #d32f2f;
    --border-radius: 12px;
}

/* -------------------- CSS Fix for Flicker -------------------- */
body:not(.auth-initialized) #auth-wrap,
body:not(.auth-initialized) .container {
    visibility: hidden;
}
/* ------------------------------------------------------------- */
html, body {
Â  height: 100%;
Â  margin: 0;
Â  padding: 0;
Â  font-family: 'Heebo', Arial, sans-serif; /* ×¤×•× ×˜ ××¢×•×“×›×Ÿ */
Â  direction: rtl;
Â  text-align: center;
Â  background: var(--background-color);
Â  overflow: hidden;
}

/* -------------------- LOGIN / SIGNUP -------------------- */
#auth-wrap {
Â  width: 100%;
Â  min-height: 100vh;
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  padding: 20px;
Â  box-sizing: border-box;
}
.auth-card {
Â  width: 100%;
Â  max-width: 400px; /* ×§×¦×ª ×™×•×ª×¨ ×¨×—×‘ */
Â  background: #ffffff;
Â  border-radius: var(--border-radius);
Â  box-shadow: var(--card-shadow);
Â  padding: 30px 25px; /* ××¨×•×•×— ×¤× ×™××™ ×’×“×•×œ ×™×•×ª×¨ */
Â  box-sizing: border-box;
Â  text-align: center;
}
.auth-card h2 {
Â  margin: 0 0 20px 0;
Â  font-size: 1.8rem;
Â  color: var(--primary-color);
}
.auth-card label {
Â  display: block;
Â  text-align: right;
Â  font-weight: 500;
Â  margin-top: 15px;
Â  font-size: 1rem;
Â  color: #555;
}
.auth-card input {
Â  width: 100%;
Â  padding: 12px;
Â  margin-top: 8px;
Â  box-sizing: border-box;
Â  border: 1px solid #e0e0e0;
Â  border-radius: 8px;
Â  font-size: 1rem;
Â  transition: border-color 0.3s;
}
.auth-card input:focus {
    border-color: var(--primary-color);
    outline: none;
}
.auth-actions {
Â  display: flex;
Â  gap: 10px;
Â  margin-top: 20px;
Â  justify-content: center;
Â  flex-wrap: wrap;
}
.auth-actions button {
Â  padding: 12px 20px;
Â  font-size: 1.05rem;
Â  border-radius: 8px;
Â  border: none;
Â  cursor: pointer;
Â  transition: all 0.3s;
}
.btn-primary {
Â  background: var(--primary-color);
Â  color: white;
Â  box-shadow: 0 4px 8px rgba(0, 121, 107, 0.3);
}
.btn-primary:hover {
    background: #00695c;
    box-shadow: 0 6px 12px rgba(0, 121, 107, 0.4);
}
.btn-ghost {
Â  background: transparent;
Â  color: var(--primary-color);
Â  border: 1px solid var(--primary-color);
}
.btn-ghost:hover {
    background: #e0f2f1;
}
.link-small {
Â  margin-top: 15px;
Â  display: block;
Â  color: #777;
Â  font-size: 0.95rem;
Â  cursor: pointer;
}

/* -------------------- APP CONTAINER STYLES -------------------- */

.container {
Â  flex: 1;
Â  max-width: 100%;
Â  height: 100vh;
Â  margin: 0 auto;
Â  padding: 15px;
Â  box-sizing: border-box;
Â  overflow-y: auto;
Â  background: var(--background-color); /* ×¨×§×¢ ×‘×”×™×¨ */
Â  display: flex;
Â  flex-direction: column;
Â  justify-content: flex-start;
}
.container > :last-child {
Â  margin-bottom: 50px; /* × ×× ×¢ ××’×œ×™×œ×” ××™×•×ª×¨×ª */
}

h2 { font-size: 2.2rem; margin-bottom: 0px; color: #333; }
h3 { 
    font-size: 1.7rem; 
    margin: 20px 0 10px 0; 
    color: var(--primary-color); 
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 5px;
}
h4 { font-size: 1.4rem; margin-bottom: 0px; color: #555; }

/* ×©×™×¤×•×¨ ×›×¤×ª×•×¨×™× ×›×œ×œ×™ */
button {
Â  padding: 10px 20px;
Â  margin: 6px;
Â  border: none;
Â  background: var(--primary-light); /* ×›×¤×ª×•×¨×™× ×¤×—×•×ª ×“×•××™× × ×˜×™×™×, ×œ××¡×›×™ ×‘×—×™×¨×” */
Â  color: white;
Â  border-radius: 8px;
Â  cursor: pointer;
Â  font-size: 1.1rem;
Â  transition: background 0.3s, transform 0.1s;
}
button:hover { 
    background: var(--primary-color); 
    transform: translateY(-1px);
}

/* ×›×¤×ª×•×¨ ×©××•×¨ / ×¨××©×™ ×‘××¤×œ×™×§×¦×™×” */
#view-form button:not([onclick*="back"]),
#view-sport-events button:not([onclick*="back"]),
#view-social-meeting button:not([onclick*="back"]) {
    background: var(--primary-color);
    font-size: 1.2rem;
    padding: 12px 24px;
}

/* ×›×¤×ª×•×¨ ×™×¦×™××” */
.logout-btn { 
    background: var(--danger-color) !important; 
    font-size: 1rem !important; 
    padding: 6px 10px !important; 
    margin-right: auto; /* ×“×•×—×£ ×©×××œ×” (×¤×™× ×ª ×”××¡×š ×‘×¨×˜"×œ) */
    box-shadow: 0 2px 4px rgba(211, 47, 47, 0.3);
}

.hidden { display: none; }

/* ×©×™×¤×•×¨ ×©×“×•×ª ×§×œ×˜ */
input, textarea, select {
Â  width: 100%;
Â  padding: 12px;
Â  margin: 8px 0;
Â  font-size: 1.1rem;
Â  box-sizing: border-box;
Â  border: 1px solid #ccc;
Â  border-radius: 8px;
Â  background: #ffffff;
}
input:focus, textarea:focus, select:focus {
    border-color: var(--primary-light);
    box-shadow: 0 0 0 2px rgba(0, 121, 107, 0.1);
    outline: none;
}

img#preview {
Â  max-width: 200px;
Â  max-height: 200px;
Â  margin: 10px 0;
Â  height: auto;
Â  border: 2px dashed #ccc;
Â  border-radius: var(--border-radius);
Â  object-fit: cover;
}

img { max-width: 100%; margin: 8px 0; height: auto; border-radius: 8px; }

/* ×©×™×¤×•×¨ ×›×¨×˜×™×¡×™ ×”×¢×¨×•×ª/××™×¨×•×¢×™× */
.note, .event, .social {
Â  background: #ffffff;
Â  border-left: 5px solid var(--primary-light);
Â  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
Â  padding: 12px;
Â  margin: 12px 0;
Â  border-radius: 8px;
Â  text-align: right;
Â  word-wrap: break-word;
Â  font-size: 1.1rem;
}

.note h4 {
    color: var(--primary-color);
    margin-top: 0;
    margin-bottom: 5px;
    font-size: 1.4rem;
}

.reply {
Â  margin-right: 20px;
Â  margin-top: 10px;
Â  border-right: 3px solid var(--accent-color); /* ×¦×‘×¢ ×©×•× ×” ×œ×ª×’×•×‘×” */
Â  padding-right: 10px;
Â  font-size: 1rem;
Â  background: #fffde7; /* ×¨×§×¢ ×¢×“×™×Ÿ ×œ×ª×’×•×‘×•×ª */
Â  border-radius: 0 8px 8px 0;
}
.reply p {
    margin-top: 5px;
    margin-bottom: 0;
    font-size: 1.1rem;
}

label {
Â  font-weight: 500;
Â  margin-top: 10px;
Â  display: block;
Â  text-align: right;
Â  font-size: 1.1rem;
}

#cancelImageBtn { 
    background: var(--danger-color); 
    padding: 8px 12px;
    font-size: 1rem;
}
#cancelImageBtn:hover { background: #b71c1c; }

/* ×§×‘×•×¦×•×ª ×›×¤×ª×•×¨×™× (×‘×—×¨ ×©×›×‘×”/××§×¦×•×¢) */
#view-grades button, #subject-list button, #category-list button, #social-locations button {
    background: var(--primary-light);
    margin: 8px 5px;
    min-width: 120px;
    padding: 12px 15px;
    font-size: 1.2rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
#view-grades button:hover, #subject-list button:hover, #category-list button:hover, #social-locations button:hover {
    background: var(--primary-color);
}
#subject-list, #category-list, #social-locations {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 5px;
}

@media (max-width: 480px) {
Â  .container { padding: 10px; }
Â  h2 { font-size: 2rem; }
Â  h3 { font-size: 1.5rem; }
Â  h4 { font-size: 1.3rem; }
Â  button { width: 95%; padding: 10px; font-size: 1.1rem; margin: 5px 0; }
Â  input, textarea, select { padding: 10px; font-size: 1.1rem; }
Â  .note, .event, .social { font-size: 1.1rem; padding: 10px; }
    #view-grades button, #subject-list button, #category-list button, #social-locations button {
        min-width: 45%;
    }
}
</style>
</head>
<body>

<div id="auth-wrap">
Â  <div id="auth-card" class="auth-card" role="region" aria-label="login">
Â  Â  <h2>×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª ğŸ”‘</h2>

Â  Â  <label for="firstName">×©× ×¤×¨×˜×™</label>
Â  Â  <input id="firstName" type="text" autocomplete="given-name" placeholder="×©× ×¤×¨×˜×™">

Â  Â  <label for="lastName">×©× ××©×¤×—×”</label>
Â  Â  <input id="lastName" type="text" autocomplete="family-name" placeholder="×©× ××©×¤×—×”">

Â  Â  <label for="password">×¡×™×¡××”</label>
Â  Â  <input id="password" type="password" autocomplete="current-password" placeholder="×¡×™×¡××”">

Â  Â  <div class="auth-actions">
Â  Â  Â  <button class="btn-primary" onclick="login()">×”×ª×—×‘×¨</button>
Â  Â  Â  <button class="btn-ghost" onclick="showSignup()">×”×¨×©××”</button>
Â  Â  </div>

Â  Â  <span class="link-small" id="auth-msg" aria-live="polite"></span>
Â  </div>

Â  Â  <div id="signup-card" class="auth-card hidden" role="region" aria-label="signup">
Â  Â  <h2>×”×¨×©××” ×—×“×©×” âœï¸</h2>

Â  Â  <label for="signup-first">×©× ×¤×¨×˜×™</label>
Â  Â  <input id="signup-first" type="text" placeholder="×©× ×¤×¨×˜×™">

Â  Â  <label for="signup-last">×©× ××©×¤×—×”</label>
Â  Â  <input id="signup-last" type="text" placeholder="×©× ××©×¤×—×”">

Â  Â  <label for="signup-pass">×¡×™×¡××”</label>
Â  Â  <input id="signup-pass" type="password" placeholder="×¡×™×¡××”">

Â  Â  <div class="auth-actions">
Â  Â  Â  <button class="btn-primary" onclick="signup()">×¦×•×¨ ××©×ª××©</button>
Â  Â  Â  <button class="btn-ghost" onclick="hideSignup()">×—×–×•×¨ ×œ×”×ª×—×‘×¨×•×ª</button>
Â  Â  </div>

Â  Â  <span class="link-small" id="signup-msg" aria-live="polite"></span>
Â  </div>
</div>
<div class="container hidden">

Â  Â  <div style="display: flex; justify-content: flex-start; margin-bottom: 10px; width: 100%;">
Â  Â  Â  Â  <button class="logout-btn" onclick="logout()">×™×¦×™××” ğŸšª</button>
Â  Â  </div>

Â  <div id="view-grades">
Â  Â  Â  Â  <img src="https://i.imgur.com/rEEphAR.jpeg" alt="×œ×•×’×• ×‘×™×ª ×¡×¤×¨" style="max-width:200px; margin:10px auto 30px auto; display:block;">

Â  Â  <h3>×‘×—×¨ ×©×›×‘×ª ×’×™×œ ğŸ‘‡</h3>
    <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
Â  Â      <button onclick="openGrade('×–')">×©×›×‘×ª ×–'</button>
Â  Â      <button onclick="openGrade('×—')">×©×›×‘×ª ×—'</button>
Â  Â      <button onclick="openGrade('×˜')">×©×›×‘×ª ×˜'</button>
    </div>
Â  </div>

Â  <div id="view-subjects" class="hidden">
Â  Â  <h3 id="subject-title"></h3>
Â  Â  
    <h4>ğŸ“š ××§×¦×•×¢×•×ª ×œ×™××•×“</h4>
Â  Â  <div id="subject-list"></div>

Â  Â  <h4>ğŸ“‚ ×§×˜×’×•×¨×™×•×ª × ×•×¡×¤×•×ª</h4>
Â  Â  <div id="category-list"></div>
Â  Â  <button onclick="backToGrades()" style="background: #607d8b; margin-top: 20px;">â¬… ×—×–×¨×” ×œ×‘×—×™×¨×ª ×©×›×‘×”</button>
Â  </div>

Â  <div id="view-form" class="hidden">
Â  Â  <h3 id="form-title"></h3>
Â  Â  <label for="comment">×©× ×”×ª×œ××™×“/××’×™×© ×”×”×¦×¢×”:</label>
Â  Â  <input type="text" id="comment" placeholder="×©× ×”×ª×œ××™×“ / ×©× ×”×”×•×¨×” / ××¦×™×¢"><br>
Â  Â  
    <label for="description">×ª×™××•×¨ ××¤×•×¨×˜:</label>
Â  Â  <textarea id="description" placeholder="×ª×™××•×¨ ×”×”×¢×¨×”/×”×‘×¢×™×”/×”×¦×¢×”"></textarea><br>
Â  Â  
    <label for="imageInput">×¦×¨×£ ×ª××•× ×” (××•×¤×¦×™×•× ×œ×™):</label>
Â  Â  <input type="file" id="imageInput"><br>
Â  Â  
    <div style="display: flex; justify-content: flex-end; width: 100%;">
        <button id="cancelImageBtn" class="hidden" onclick="cancelImage()" style="margin-left: auto;">âŒ ×‘×˜×œ ×ª××•× ×”</button>
    </div>
Â  Â  <img id="preview" class="hidden"><br>
Â  Â  
    <div style="margin-top: 20px;">
        <button onclick="saveSubject()">ğŸ’¾ ×©××•×¨ ×”×¢×¨×”</button>
        <button onclick="backToSubjects()" style="background: #607d8b;">â¬… ×—×–×¨×”</button>
    </div>

Â  Â  <h3>ğŸ“Œ ×”×¢×¨×•×ª ×©××•×¨×•×ª</h3>
Â  Â  <div id="notes-list"></div>
Â  </div>

Â  <div id="view-sport-events" class="hidden">
Â  Â  <h3>×¡×¤×•×¨×˜ - ×ª×–××•×Ÿ ××™×¨×•×¢×™× âš½ğŸ€</h3>
Â  Â  <label for="sport-event-select">×‘×—×¨ ××™×¨×•×¢:</label>
Â  Â  <select id="sport-event-select">
Â  Â  Â  <option value="×›×“×•×¨×’×œ">×›×“×•×¨×’×œ</option>
Â  Â  Â  <option value="×›×“×•×¨×¡×œ">×›×“×•×¨×¡×œ</option>
Â  Â  Â  <option value="×¨×™×¦×”">×¨×™×¦×”</option>
Â  Â  </select><br>
Â  Â  <label for="sport-date">×ª××¨×™×š:</label>
Â  Â  <input type="date" id="sport-date"><br>
Â  Â  <label for="sport-time">×©×¢×”:</label>
Â  Â  <input type="time" id="sport-time"><br>
Â  Â  
    <div style="margin-top: 20px;">
        <button onclick="saveSportEvent()">ğŸ’¾ ×©××•×¨ ××™×¨×•×¢</button>
        <button onclick="backToSubjects()" style="background: #607d8b;">â¬… ×—×–×¨×”</button>
    </div>

Â  Â  <h3>ğŸ“Œ ××™×¨×•×¢×™× ×©××•×¨×™×</h3>
Â  Â  <div id="sport-events-list"></div>
Â  </div>

Â  <div id="view-social-meeting" class="hidden">
Â  Â  <h3>××¤×’×© ×—×‘×¨×ª×™ ğŸ‰</h3>
Â  Â  <h4>×‘×—×¨ ××™×§×•× ×œ××¤×’×©:</h4>
Â  Â  <div id="social-locations">
Â  Â  Â  <button onclick="selectSocialLocation('×—×“×¨ ××•×›×œ')">×—×“×¨ ××•×›×œ ğŸ•</button>
Â  Â  Â  <button onclick="selectSocialLocation('×—×¦×¨')">×—×¦×¨ ğŸŒ³</button>
Â  Â  Â  <button onclick="selectSocialLocation('×¡×¤×¨×™×”')">×¡×¤×¨×™×” ğŸ“–</button>
Â  Â  Â  <button onclick="selectSocialLocation('××•×œ× ×¡×¤×•×¨×˜')">××•×œ× ×¡×¤×•×¨×˜ ğŸ</button>
Â  Â  Â  <button onclick="selectSocialLocation('×›×™×ª×ª ××—×©×‘×™×')">×›×™×ª×ª ××—×©×‘×™× ğŸ’»</button>
Â  Â  Â  <button onclick="selectSocialLocation('×’×Ÿ ××©×—×§×™×')">×’×Ÿ ××©×—×§×™× ğŸ </button>
Â  Â  </div>
Â  Â  <div id="social-datetime" class="auth-card hidden" style="background: #e0f2f1; padding: 20px; margin-top: 20px; box-shadow: none;">
Â  Â  Â  <h4 id="selected-location"></h4>
Â  Â  Â  <label for="social-date">×ª××¨×™×š:</label>
Â  Â  Â  <input type="date" id="social-date"><br>
Â  Â  Â  <label for="social-time">×©×¢×”:</label>
Â  Â  Â  <input type="time" id="social-time"><br>
Â  Â  Â  <button onclick="saveSocialMeeting()">ğŸ’¾ ×©××•×¨ ××¤×’×©</button>
Â  Â  </div>
Â  Â  <button onclick="backToSubjects()" style="background: #607d8b; margin-top: 20px;">â¬… ×—×–×¨×”</button>
Â  Â  <h3>ğŸ“Œ ××¤×’×©×™× ×©××•×¨×™×</h3>
Â  Â  <div id="social-meetings-list"></div>
Â  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
// ---------------- YOUR ORIGINAL FIREBASE + APP CODE (UNCHANGED) ----------------
// Firebase config
const firebaseConfig = {
Â  apiKey: "AIzaSyA8JW7C-tvAw1E-2rNthoI9yG-C4zjWjM4",
Â  authDomain: "helper-a6ca2.firebaseapp.com",
Â  projectId: "helper-a6ca2",
Â  storageBucket: "helper-a6ca2.appspot.com",
Â  messagingSenderId: "710212458048",
Â  appId: "1:710212458048:web:bf0726a7f5cbf25c9b71a5",
Â  measurementId: "G-T5YL5RC934"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const defaultSubjects = ["××“×¢×™×","×¢×¨×‘×™×ª","×”×™×¡×˜×•×¨×™×”","××ª××˜×™×§×”","×× ×’×œ×™×ª","×’××•×’×¨×¤×™×”","×©×¤×”"];
const extraCategories = ["××¤×’×© ×—×‘×¨×ª×™","×¡×¤×•×¨×˜","×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ××• ×‘×§×©×•×ª"];

let currentGrade = null;
let currentSubject = null;
let selectedFile = null;
let unsubscribe = null;
let selectedSocialLocation = null;

// Open grade
function openGrade(grade) {
Â  currentGrade = grade;
Â  document.getElementById("view-grades").classList.add("hidden");
Â  document.getElementById("view-subjects").classList.remove("hidden");
Â  document.getElementById("subject-title").innerText = "××§×¦×•×¢×•×ª ×‘×©×›×‘×ª " + grade;

Â  const subjectList = document.getElementById("subject-list");
Â  subjectList.innerHTML = "";
Â  defaultSubjects.forEach(sub => {
Â  Â  const btn = document.createElement("button");
Â  Â  btn.innerText = sub;
Â  Â  btn.onclick = () => openForm(sub);
Â  Â  subjectList.appendChild(btn);
Â  });

Â  const catList = document.getElementById("category-list");
Â  catList.innerHTML = "";
Â  extraCategories.forEach(cat => {
Â  Â  const btn = document.createElement("button");
Â  Â  btn.innerText = cat;
Â  Â  if(cat === "×¡×¤×•×¨×˜") btn.onclick = openSportEvents;
Â  Â  else if(cat === "××¤×’×© ×—×‘×¨×ª×™") btn.onclick = openSocialMeeting;
Â  Â  else btn.onclick = () => openForm(cat);
Â  Â  catList.appendChild(btn);
Â  });
}

// Back navigation
function backToGrades() {
Â  document.getElementById("view-subjects").classList.add("hidden");
Â  document.getElementById("view-form").classList.add("hidden");
Â  document.getElementById("view-sport-events").classList.add("hidden");
Â  document.getElementById("view-social-meeting").classList.add("hidden");
Â  document.getElementById("view-grades").classList.remove("hidden");
}

function backToSubjects() {
Â  document.getElementById("view-form").classList.add("hidden");
Â  document.getElementById("view-sport-events").classList.add("hidden");
Â  document.getElementById("view-social-meeting").classList.add("hidden");
Â  document.getElementById("social-datetime").classList.add("hidden");
Â  document.getElementById("view-subjects").classList.remove("hidden");
}

// IMAGE UPLOAD
document.getElementById("imageInput").addEventListener("change", e => {
Â  selectedFile = e.target.files[0];
Â  const cancelBtn = document.getElementById("cancelImageBtn");
Â  const preview = document.getElementById("preview");

Â  if(selectedFile){
Â  Â  cancelBtn.classList.remove("hidden");
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = e2 => {
Â  Â  Â  preview.src = e2.target.result;
Â  Â  Â  preview.classList.remove("hidden");
Â  Â  };
Â  Â  reader.readAsDataURL(selectedFile);
Â  } else cancelImage();
});

function cancelImage(){
Â  selectedFile = null;
Â  const input = document.getElementById("imageInput");
Â  const preview = document.getElementById("preview");
Â  input.value = "";
Â  preview.src = "";
Â  preview.classList.add("hidden");
Â  document.getElementById("cancelImageBtn").classList.add("hidden");
}

// Open form
function openForm(subject) {
Â  currentSubject = subject;
Â  document.getElementById("view-subjects").classList.add("hidden");
Â  document.getElementById("view-form").classList.remove("hidden");
Â  document.getElementById("form-title").innerText = "×”×•×¡×¤×ª ×”×¢×¨×” ×œ: " + subject;
Â  document.getElementById("comment").value = "";
Â  document.getElementById("description").value = "";
Â  cancelImage();
Â  loadNotes();
}

// Save comment
async function saveSubject(parentCommentId = null) {
Â  const comment = document.getElementById("comment").value.trim();
Â  const description = document.getElementById("description").value.trim();
Â  if(!comment || !description){ alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }

Â  try {
Â  Â  let imageUrl = "";
Â  Â  if(selectedFile){
Â  Â  Â  const storageRef = storage.ref();
Â  Â  Â  const fileRef = storageRef.child(`${currentGrade}/${currentSubject}/${Date.now()}-${selectedFile.name}`);
Â  Â  Â  await fileRef.put(selectedFile);
Â  Â  Â  imageUrl = await fileRef.getDownloadURL();
Â  Â  }

Â  Â  const subjectRef = db.collection("grades").doc(currentGrade)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .collection("subjects").doc(currentSubject);
Â  Â  await subjectRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

Â  Â  if(parentCommentId){
Â  Â  Â  await subjectRef.collection("comments").doc(parentCommentId)
Â  Â  Â  Â  .collection("replies").add({
Â  Â  Â  Â  Â  comment,
Â  Â  Â  Â  Â  description,
Â  Â  Â  Â  Â  imageUrl: imageUrl || "",
Â  Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  await subjectRef.collection("comments").add({
Â  Â  Â  Â  comment,
Â  Â  Â  Â  description,
Â  Â  Â  Â  imageUrl: imageUrl || "",
Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  });
Â  Â  }

Â  Â  alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
Â  Â  document.getElementById("comment").value = "";
Â  Â  document.getElementById("description").value = "";
Â  Â  cancelImage();
Â  } catch(err){
Â  Â  console.error("Upload error:", err);
Â  Â  alert("×©×’×™××” ×‘×©××™×¨×”: "+err.message);
Â  }
}

// Load notes with real-time updates
function loadNotes() {
Â  const list = document.getElementById("notes-list");
Â  const ref = db.collection("grades").doc(currentGrade)
Â  Â  .collection("subjects").doc(currentSubject)
Â  Â  .collection("comments").orderBy("timestamp","desc");

Â  if(unsubscribe) unsubscribe();
Â  unsubscribe = ref.onSnapshot(snapshot=>{
Â  Â  list.innerHTML="";
Â  Â  snapshot.forEach(doc=>{
Â  Â  Â  const note = doc.data();
Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  div.className="note";
Â  Â  Â  div.innerHTML=`<h4>${note.comment}</h4><p>${note.description}</p>`+
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (note.imageUrl ? `<img src="${note.imageUrl}">` : "");

Â  Â  Â  // Reply button
Â  Â  Â  const replyBtn = document.createElement("button");
Â  Â  Â  replyBtn.innerText = "ğŸ’¬ ×”×©×‘";
      replyBtn.style.fontSize = '1rem';
      replyBtn.style.padding = '5px 10px';
      replyBtn.style.background = '#00bcd4';
      replyBtn.style.marginLeft = '4px';
Â  Â  Â  replyBtn.onclick = ()=> {
Â  Â  Â  Â  const replyComment = prompt("×”×–×Ÿ ××ª ×”×©× ×©×œ×š:");
Â  Â  Â  Â  const replyDesc = prompt("×›×ª×•×‘ ××ª ×”×”×•×“×¢×” ×©×œ×š:");
Â  Â  Â  Â  if(replyComment && replyDesc){
Â  Â  Â  Â  Â  saveSubjectReply(doc.id, replyComment, replyDesc);
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  div.appendChild(replyBtn);

Â  Â  Â  // Delete button
Â  Â  Â  const deleteBtn = document.createElement("button");
Â  Â  Â  deleteBtn.innerText = "ğŸ—‘ï¸ ××—×§";
      deleteBtn.style.fontSize = '1rem';
      deleteBtn.style.padding = '5px 10px';
Â  Â  Â  deleteBtn.style.background = "#d32f2f";
Â  Â  Â  deleteBtn.style.marginLeft = "0px";
Â  Â  Â  deleteBtn.onclick = async () => {
Â  Â  Â  Â  if(confirm("×œ××—×•×§ ×”×¢×¨×” ×–×•?")) {
Â  Â  Â  Â  Â  await doc.ref.delete();
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  div.appendChild(deleteBtn);

Â  Â  Â  // Load replies in real-time
Â  Â  Â  doc.ref.collection("replies").orderBy("timestamp","asc").onSnapshot(replySnap=>{
Â  Â  Â  Â  const oldReplies = div.querySelectorAll(".reply");
Â  Â  Â  Â  oldReplies.forEach(r => r.remove());
Â  Â  Â  Â  replySnap.forEach(replyDoc=>{
Â  Â  Â  Â  Â  const r = replyDoc.data();
Â  Â  Â  Â  Â  const rDiv = document.createElement("div");
Â  Â  Â  Â  Â  rDiv.className="reply";
Â  Â  Â  Â  Â  rDiv.innerHTML=`<strong>${r.comment}</strong><p>${r.description}</p>`+
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (r.imageUrl ? `<img src="${r.imageUrl}">` : "");

Â  Â  Â  Â  Â  // Delete reply
Â  Â  Â  Â  Â  const delReplyBtn = document.createElement("button");
Â  Â  Â  Â  Â  delReplyBtn.innerText = "ğŸ—‘ï¸ ××—×§";
      Â  delReplyBtn.style.fontSize = '0.9rem';
      delReplyBtn.style.padding = '3px 8px';
Â  Â  Â  Â  Â  delReplyBtn.style.background = "#d32f2f";
Â  Â  Â  Â  Â  delReplyBtn.style.marginLeft = "4px";
Â  Â  Â  Â  Â  delReplyBtn.onclick = async () => {
Â  Â  Â  Â  Â  Â  if(confirm("×œ××—×•×§ ×ª×’×•×‘×” ×–×•?")) {
Â  Â  Â  Â  Â  Â  Â  await replyDoc.ref.delete();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  rDiv.appendChild(delReplyBtn);

Â  Â  Â  Â  Â  div.appendChild(rDiv);
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  list.appendChild(div);
Â  Â  });
Â  });
}

// Save reply
async function saveSubjectReply(parentCommentId, comment, description){
Â  const subjectRef = db.collection("grades").doc(currentGrade)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .collection("subjects").doc(currentSubject);
Â  await subjectRef.collection("comments").doc(parentCommentId)
Â  Â  .collection("replies").add({
Â  Â  Â  comment,
Â  Â  Â  description,
Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  });
}

// SPORT EVENTS
function openSportEvents(){
Â  document.getElementById("view-subjects").classList.add("hidden");
Â  document.getElementById("view-sport-events").classList.remove("hidden");
Â  loadSportEvents();
}

function saveSportEvent(){
Â  const eventName = document.getElementById("sport-event-select").value;
Â  const date = document.getElementById("sport-date").value;
Â  const time = document.getElementById("sport-time").value;
Â  if(!date || !time){ alert("×× × ×‘×—×¨ ×ª××¨×™×š ×•×©×¢×”"); return; }
Â  db.collection("grades").doc(currentGrade)
Â  Â  .collection("sport_events").add({
Â  Â  Â  name: eventName,
Â  Â  Â  date,
Â  Â  Â  time,
Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  }).then(()=>loadSportEvents());
}

function loadSportEvents(){
Â  const list = document.getElementById("sport-events-list");
Â  list.innerHTML = "";
Â  db.collection("grades").doc(currentGrade)
Â  Â  .collection("sport_events").orderBy("timestamp","desc")
Â  Â  .get().then(snapshot=>{
Â  Â  Â  snapshot.forEach(doc=>{
Â  Â  Â  Â  const e = doc.data();
Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  div.className="event";
Â  Â  Â  Â  div.innerText = `${e.name} - ${e.date} ${e.time}`;

Â  Â  Â  Â  // Delete button
Â  Â  Â  Â  const delBtn = document.createElement("button");
Â  Â  Â  Â  delBtn.innerText = "ğŸ—‘ï¸ ××—×§";
      delBtn.style.fontSize = '1rem';
      delBtn.style.padding = '5px 10px';
Â  Â  Â  Â  delBtn.style.background = "#d32f2f";
Â  Â  Â  Â  delBtn.style.marginLeft = "4px";
Â  Â  Â  Â  delBtn.onclick = async () => {
Â  Â  Â  Â  Â  if(confirm("×œ××—×•×§ ××™×¨×•×¢ ×–×”?")) {
Â  Â  Â  Â  Â  Â  await doc.ref.delete();
Â  Â  Â  Â  Â  Â  loadSportEvents();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  div.appendChild(delBtn);

Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  });
Â  Â  });
}

// SOCIAL MEETING
function openSocialMeeting(){
Â  document.getElementById("view-subjects").classList.add("hidden");
Â  document.getElementById("view-social-meeting").classList.remove("hidden");
Â  document.getElementById("social-datetime").classList.add("hidden");
Â  loadSocialMeetings();
}

function selectSocialLocation(location){
Â  selectedSocialLocation = location;
Â  document.getElementById("selected-location").innerText = location;
Â  document.getElementById("social-datetime").classList.remove("hidden");
}

function saveSocialMeeting(){
Â  const date = document.getElementById("social-date").value;
Â  const time = document.getElementById("social-time").value;
Â  if(!selectedSocialLocation || !date || !time){ alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }
Â  db.collection("grades").doc(currentGrade)
Â  Â  .collection("social_meetings").add({
Â  Â  Â  location: selectedSocialLocation,
Â  Â  Â  date,
Â  Â  Â  time,
Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  }).then(()=> loadSocialMeetings());
}

function loadSocialMeetings(){
Â  const list = document.getElementById("social-meetings-list");
Â  list.innerHTML = "";
Â  db.collection("grades").doc(currentGrade)
Â  Â  .collection("social_meetings").orderBy("timestamp","desc")
Â  Â  .get().then(snapshot=>{
Â  Â  Â  snapshot.forEach(doc=>{
Â  Â  Â  Â  const e = doc.data();
Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  div.className="social";
Â  Â  Â  Â  div.innerText = `${e.location} - ${e.date} ${e.time}`;

Â  Â  Â  Â  // Delete button
Â  Â  Â  Â  const delBtn = document.createElement("button");
Â  Â  Â  Â  delBtn.innerText = "ğŸ—‘ï¸ ××—×§";
      delBtn.style.fontSize = '1rem';
      delBtn.style.padding = '5px 10px';
Â  Â  Â  Â  delBtn.style.background = "#d32f2f";
Â  Â  Â  Â  delBtn.style.marginLeft = "4px";
Â  Â  Â  Â  delBtn.onclick = async () => {
Â  Â  Â  Â  Â  if(confirm("×œ××—×•×§ ××¤×’×© ×–×”?")) {
Â  Â  Â  Â  Â  Â  await doc.ref.delete();
Â  Â  Â  Â  Â  Â  loadSocialMeetings();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  div.appendChild(delBtn);

Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  });
Â  Â  });
}
// ---------------- END ORIGINAL APP CODE ----------------
</script>

<script>
const auth = firebase.auth();

// utility: make email from first + last
function makeEmail(first, last){
Â  // normalize spaces and remove dots
Â  const f = (first || "").trim().replace(/\s+/g,"").replace(/\./g, '');Â 
Â  const l = (last || "").trim().replace(/\s+/g,"").replace(/\./g, '');
Â  return `${f}.${l}@myschool.local`.toLowerCase();
}

// show/hide signup
function showSignup(){
Â  document.getElementById('auth-card').classList.add('hidden');
Â  document.getElementById('signup-card').classList.remove('hidden');
Â  document.getElementById('auth-msg').innerText = "";
}
function hideSignup(){
Â  document.getElementById('signup-card').classList.add('hidden');
Â  document.getElementById('auth-card').classList.remove('hidden');
Â  document.getElementById('signup-msg').innerText = "";
}

// login (×›×•×œ×œ ×˜×™×¤×•×œ ××©×•×¤×¨ ×‘×©×’×™××•×ª)
async function login(){
Â  const first = document.getElementById('firstName').value.trim();
Â  const last = document.getElementById('lastName').value.trim();
Â  const pass = document.getElementById('password').value;

Â  if(!first || !last || !pass){
Â  Â  document.getElementById('auth-msg').innerText = "×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª";
Â  Â  return;
Â  }

Â  const email = makeEmail(first, last);
Â  try {
Â  Â  document.getElementById('auth-msg').innerText = "×× ×¡×” ×œ×”×ª×—×‘×¨...";
Â  Â  await auth.signInWithEmailAndPassword(email, pass);
Â  } catch(err){
Â  Â  console.error("Login Error:", err);
Â  Â  let errorMsg = "×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª. ×•×“× ×©×©× ×”××©×ª××© ×•×”×¡×™×¡××” × ×›×•× ×™×.";
Â  Â  if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
Â  Â  Â  Â  errorMsg = "×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×.";
Â  Â  } else if (err.code === 'auth/invalid-email') {
Â  Â  Â  Â  errorMsg = "×¤×•×¨××˜ ×©× ××©×ª××© (××™××™×™×œ) ×©×’×•×™. ×•×“× ×©×©× ×¤×¨×˜×™ ×•××©×¤×—×” ×ª×§×™× ×™×.";
Â  Â  }
Â  Â  document.getElementById('auth-msg').innerText = errorMsg;
Â  }
}

// signup
async function signup(){
Â  const first = document.getElementById('signup-first').value.trim();
Â  const last = document.getElementById('signup-last').value.trim();
Â  const pass = document.getElementById('signup-pass').value;

Â  if(!first || !last || !pass){
Â  Â  document.getElementById('signup-msg').innerText = "×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª";
Â  Â  return;
Â  }

Â  const email = makeEmail(first, last);
Â  try {
Â  Â  document.getElementById('signup-msg').innerText = "×™×•×¦×¨ ××©×ª××©...";
Â  Â  const res = await auth.createUserWithEmailAndPassword(email, pass);
Â  Â  const full = first + " " + last;
Â  Â  if(res && res.user){
Â  Â  Â  await res.user.updateProfile({ displayName: full });
Â  Â  }
Â  Â  document.getElementById('signup-msg').innerText = "×”××©×ª××© × ×•×¦×¨! ×›×¢×ª ×”×ª×—×‘×¨.";
Â  Â  setTimeout(()=> {
Â  Â  Â  hideSignup();
Â  Â  }, 800);
Â  } catch(err){
Â  Â  console.error("Signup Error:", err);
Â  Â  document.getElementById('signup-msg').innerText = "×©×’×™××” ×‘×”×¨×©××”: " + err.message;
Â  }
}

// logout
async function logout(){
Â  await auth.signOut();
}

// handle auth state changes (××•× ×¢ ×”×‘×”×•×‘)
auth.onAuthStateChanged(user => {
Â  const authWrap = document.getElementById('auth-wrap');
Â  const app = document.querySelector('.container');

Â  // 1. ×××©×¨ ×©×”×‘×“×™×§×” ×‘×•×¦×¢×” (××˜×¤×œ ×‘-CSS ×©×œ ×”×”×‘×”×•×‘)
Â  document.body.classList.add('auth-initialized');
Â Â 
Â  if(user){
Â  Â  // hide auth UI, show app
Â  Â  authWrap.classList.add('hidden');
Â  Â  app.classList.remove('hidden');
Â  Â  console.log("Logged in:", user.uid, user.email, user.displayName);
Â  } else {
Â  Â  // show auth UI, hide app
Â  Â  authWrap.classList.remove('hidden');
Â  Â  app.classList.add('hidden');
Â  }
});
</script>
</body>
</html>
