<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>Helper School App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  direction: rtl;
  text-align: center;
  background: #f7f7f7;
  overflow: hidden;
}

body {
  display: flex;
  justify-content: center;
  align-items: stretch;
}

.container {
  flex: 1;
  max-width: 100%;
  height: 100vh;
  margin: 0;
  padding: 10px;
  box-sizing: border-box;
  overflow-y: auto;
  background: white;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}
/* Adjusted margin to account for the fixed logout button at the bottom */
#view-grades > :last-child:not(.logout-btn),
#view-subjects > :last-child,
#view-form > :last-child,
#view-sport-events > :last-child,
#view-social-meeting > :last-child,
#view-lost-found > :last-child,
#view-global-search > :last-child {
  margin-bottom: 70px; /* Give space above the fixed button if necessary */
}

h2 { font-size: 2rem; margin-bottom: 0px; }
h3 { font-size: 1.6rem; margin-bottom: 0px; }
h4 { font-size: 1.4rem; margin-bottom: 0px; }

button {
  padding: 8px 16px;
  margin: 4px 2px;
  border: none;
  background: #1976d2;
  color: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1.4rem;
  transition: background 0.3s;
  /* Added for positioning the badge */
  position: relative; 
}

button:hover { background: #1565c0; }

.hidden { display: none !important; }

input, textarea, select {
  width: 95%;
  padding: 8px;
  margin: 4px 0;
  font-size: 1.4rem;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 4px;
}
/* Style for the disabled name field */
input[readonly] {
    background-color: #f0f0f0;
    color: #666;
    cursor: not-allowed;
}

/* Search Input Specific Style */
.search-input {
    border: 2px solid #00796b; /* Changed color to match global button */
    border-radius: 20px;
    padding: 10px;
    margin-bottom: 10px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300796b' width='18px' height='18px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 10px center;
    padding-left: 35px; /* Space for icon */
}

img#preview, img#lf-preview {
  max-width: 150px;
  max-height: 150px;
  margin: 8px 0;
  height: auto;
  border: 1px solid #ccc;
  border-radius: 6px;
}

img { max-width: 100%; margin: 8px 0; height: auto; }

.note, .event, .social, .lf-item, .global-result {
  border: 1px solid #ddd;
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  text-align: right;
  word-wrap: break-word;
  font-size: 1.4rem;
}
/* Style for global search results */
.global-result {
    border-left: 5px solid #00796b; /* Teal color for global */
    background-color: #e0f2f1;
}

.reply {
  margin-right: 20px;
  margin-top: 6px;
  border-right: 2px solid #1976d2;
  padding-right: 6px;
  font-size: 1.3rem;
  background: #f1f1f1;
}

/* Specific style for event comments to look distinct */
.event-comments-section {
    background: #f9f9f9;
    border-top: 1px solid #eee;
    margin-top: 10px;
    padding: 5px;
    display: none; /* Hidden by default */
}
.event-comments-section.open {
    display: block;
}

label {
  font-weight: bold;
  margin-top: 6px;
  display: block;
  text-align: right;
  font-size: 1.2rem;
}

#cancelImageBtn, #cancelLfImageBtn { background: #d32f2f; }
#cancelImageBtn:hover, #cancelLfImageBtn:hover { background: #b71c1c; }

/* Login Specific Styles */
#view-login {
    justify-content: center; 
    align-items: center;
}
.login-box {
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}
/* --- UPDATED LOGOUT BUTTON STYLES --- */
.logout-btn {
    position: fixed; 
    bottom: 10px;    
    left: 50%;       
    transform: translateX(-50%); 
    width: 90%;      
    max-width: 400px; 
    background: #d32f2f;
    font-size: 1.4rem; 
    padding: 10px;
    z-index: 1000;   
    margin: 0;
}

/* --- NEW MESSAGE INDICATOR STYLES --- */
.new-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: red;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    border: 2px solid white;
}

/* Attendee List Style */
.attendees-list {
    font-size: 1rem;
    color: #555;
    margin-top: 5px;
    background: #e3f2fd;
    padding: 4px;
    border-radius: 4px;
}


@media (max-width: 480px) {
  .container { padding: 5px; }
  h2 { font-size: 1.8rem; }
  h3 { font-size: 1.4rem; }
  h4 { font-size: 1.2rem; }
  /* Ensure grade buttons and other buttons don't conflict with fixed logout button */
  button:not(.logout-btn) { width: 90%; padding: 6px; font-size: 1.2rem; margin: 3px 0; }
  input, textarea, select { padding: 6px; font-size: 1.2rem; }
  .note, .event, .social, .lf-item, .global-result { font-size: 1.2rem; padding: 6px; }
}
</style>
</head>
<body>
<div class="container">

  <div id="view-login">
    <img src="https://i.imgur.com/rEEphAR.jpeg" alt="" style="max-width:200px; margin:10px auto; display:block;">
    <div class="login-box">
        <h3>×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª</h3>
        <input type="text" id="login-name" placeholder="×©× ××©×ª××© (×‘×× ×’×œ×™×ª ××• ×¢×‘×¨×™×ª)">
        <input type="password" id="login-pass" placeholder="×¡×™×¡××” (×œ×¤×—×•×ª 6 ×ª×•×•×™×)">
        <button onclick="handleLogin()">×›× ×™×¡×”</button>
        <button onclick="handleRegister()" style="background-color: #4caf50;">×”×¨×©××” ×¨××©×•× ×™×ª</button>
        <p id="login-error" style="color:red; font-size:1.2rem;"></p>
    </div>
  </div>

  <div id="view-grades" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; width:95%;">
        <h4 id="user-greeting"></h4>
    </div>
    
    <img src="https://i.imgur.com/rEEphAR.jpeg" alt="" style="max-width:150px; margin:5px auto; display:block;">

    <h3>×‘×—×¨ ×©×›×‘×ª ×’×™×œ</h3>
    <button id="grade-z-btn" onclick="openGrade('×–')">×–</button>
    <button id="grade-h-btn" onclick="openGrade('×—')">×—</button>
    <button id="grade-t-btn" onclick="openGrade('×˜')">×˜</button>

    <hr style="width:80%; margin: 20px auto;">
    <button onclick="openGlobalSearch()" style="background-color: #00796b;">ğŸŒ ×—×™×¤×•×© ×’×œ×•×‘×œ×™ (×”×¢×¨×•×ª ×•××™×¨×•×¢×™×)</button>
    <button onclick="openLostAndFound()" style="background-color: #ff9800;">ğŸ” ××‘×“×•×ª ×•××¦×™××•×ª (×›×œ×œ×™)</button>

    <button class="logout-btn" onclick="handleLogout()">×™×¦×™××”</button>
  </div>
  
  <div id="view-global-search" class="hidden">
    <h3>ğŸŒ ×—×™×¤×•×© ×’×œ×•×‘×œ×™</h3>
    <p style="font-size: 0.9rem; color: #666;">××—×¤×© ×”×¢×¨×•×ª, ××™×¨×•×¢×™ ×¡×¤×•×¨×˜ ×•××¤×’×©×™× ×—×‘×¨×ª×™×™× ×‘×›×œ ×”×©×›×‘×•×ª.</p>
    <input type="text" id="search-global" class="search-input" placeholder="ğŸ” ×—×¤×© ×ª×•×›×Ÿ, ××™×¨×•×¢, ××• ×©× ××©×ª××©..." onkeyup="filterGlobalItems(this.value)">
    <div id="global-results-list">
        <p>×˜×•×¢×Ÿ ×ª×•×¦××•×ª ×¨××©×•× ×™×•×ª...</p>
    </div>
    <button onclick="backToGrades()">â¬… ×—×–×¨×”</button>
  </div>

  <div id="view-lost-found" class="hidden">
    <h3>ğŸ” ××‘×“×•×ª ×•××¦×™××•×ª - ×›×œ×œ×™</h3>
    <p style="font-size: 0.9rem; color: #666;">×¨×©×™××” ××©×•×ª×¤×ª ×œ×›×œ ×”×©×›×‘×•×ª</p>
    
    <input type="text" id="lf-comment" placeholder="×©× ×”××©×ª××© (××•×˜×•××˜×™)" readonly><br>
    <textarea id="lf-description" placeholder="××” ××‘×“/× ××¦×? ×ª×™××•×¨ ×”×¤×¨×™×˜..."></textarea><br>
    <input type="file" id="lfImageInput"><br>
    <button id="cancelLfImageBtn" class="hidden" onclick="cancelLfImage()">âŒ ×‘×˜×œ ×ª××•× ×”</button><br>
    <img id="lf-preview" class="hidden"><br>
    <button onclick="saveLostItem()">ğŸ’¾ ×¤×¨×¡× ××•×“×¢×”</button>
    
    <button onclick="backToGrades()">â¬… ×—×–×¨×” ×œ××¡×š ×¨××©×™</button>
    
    <h3>ğŸ“Œ ××•×“×¢×•×ª ××—×¨×•× ×•×ª</h3>
    <div id="lf-list"></div>
  </div>

  <div id="view-subjects" class="hidden">
    <h3 id="subject-title"></h3>
    
    <div id="subject-list"></div>
    <h3>ğŸ“‚ ×§×˜×’×•×¨×™×•×ª × ×•×¡×¤×•×ª</h3>
    <div id="category-list"></div>
    <button onclick="backToGrades()">â¬… ×—×–×¨×”</button>
  </div>

  <div id="view-form" class="hidden">
    <h3 id="form-title"></h3>
    <input type="text" id="comment" placeholder="×©× ×”××©×ª××© ×©×œ×š (×œ× × ×™×ª×Ÿ ×œ×©×™× ×•×™)" readonly><br>
    <textarea id="description" placeholder="×ª×™××•×¨"></textarea><br>
    <input type="file" id="imageInput"><br>
    <button id="cancelImageBtn" class="hidden" onclick="cancelImage()">âŒ ×‘×˜×œ ×ª××•× ×”</button><br>
    <img id="preview" class="hidden"><br>
    <button onclick="saveSubject()">ğŸ’¾ ×©××•×¨</button>
    <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
    
    <h3>ğŸ“Œ ×”×¢×¨×•×ª ×©××•×¨×•×ª</h3>
    <div id="notes-list"></div>
  </div>

  <div id="view-sport-events" class="hidden">
    <h3>×¡×¤×•×¨×˜ - ×ª×–××•×Ÿ ××™×¨×•×¢×™×</h3>
    <select id="sport-event-select">
      <option value="×›×“×•×¨×’×œ">×›×“×•×¨×’×œ</option>
      <option value="×›×“×•×¨×¡×œ">×›×“×•×¨×¡×œ</option>
      <option value="×¨×™×¦×”">×¨×™×¦×”</option>
    </select><br>
    <label for="sport-date">×ª××¨×™×š:</label>
    <input type="date" id="sport-date"><br>
    <label for="sport-time">×©×¢×”:</label>
    <input type="time" id="sport-time"><br>
    <button onclick="saveSportEvent()">ğŸ’¾ ×©××•×¨ ××™×¨×•×¢</button>
    <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>
    
    <h3>ğŸ“Œ ××™×¨×•×¢×™× ×©××•×¨×™×</h3>
    <div id="sport-events-list"></div>
  </div>

  <div id="view-social-meeting" class="hidden">
    <h3>××¤×’×© ×—×‘×¨×ª×™</h3>
    <div id="social-locations">
      <button onclick="selectSocialLocation('×—×¦×¨')">×—×¦×¨</button>
      <button onclick="selectSocialLocation('×¡×¤×¨×™×”')">×¡×¤×¨×™×”</button>
      <button onclick="selectSocialLocation('××•×œ× ×¡×¤×•×¨×˜')">××•×œ× ×¡×¤×•×¨×˜</button>
      <button onclick="selectSocialLocation('×›×™×ª×ª ××—×©×‘×™×')">×›×™×ª×ª ××—×©×‘×™×</button>
      <button onclick="selectSocialLocation('×’×Ÿ ××©×—×§×™×')">×’×Ÿ ××©×—×§×™×</button>
    </div>
    <div id="social-datetime" class="hidden">
      <h4 id="selected-location"></h4>
      <label for="social-date">×ª××¨×™×š:</label>
      <input type="date" id="social-date"><br>
      <label for="social-time">×©×¢×”:</label>
      <input type="time" id="social-time"><br>
      <button onclick="saveSocialMeeting()">ğŸ’¾ ×©××•×¨ ××¤×’×©</button>
    </div>
    <button onclick="backToSubjects()">â¬… ×—×–×¨×”</button>

    <h3>ğŸ“Œ ××¤×’×©×™× ×©××•×¨×™×</h3>
    <div id="social-meetings-list"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA8JW7C-tvAw1E-2rNthoI9yG-C4zjWjM4",
  authDomain: "helper-a6ca2.firebaseapp.com",
  projectId: "helper-a6ca2",
  storageBucket: "helper-a6ca2.appspot.com",
  messagingSenderId: "710212458048",
  appId: "1:710212458048:web:bf0726a7f5cbf25c9b71a5",
  measurementId: "G-T5YL5RC934"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
const auth = firebase.auth();

// --- ADMIN CREDENTIALS ---
const ADMIN_NAME = "admin";
const ADMIN_PASS = "admin";

const GRADES = ['×–', '×—', '×˜'];
const defaultSubjects = ["××“×¢×™×","×¢×¨×‘×™×ª","×”×™×¡×˜×•×¨×™×”","××ª××˜×™×§×”","×× ×’×œ×™×ª","×’××•×’×¨×¤×™×”","×©×¤×”"];
const extraCategories = ["××¤×’×© ×—×‘×¨×ª×™","×¡×¤×•×¨×˜","×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ××• ×‘×§×©×•×ª"];
const ALL_SUBJECTS = [...defaultSubjects, ...extraCategories.filter(c => c !== "×¡×¤×•×¨×˜" && c !== "××¤×’×© ×—×‘×¨×ª×™")]; // Subjects that hold comments

let currentGrade = null;
let currentSubject = null;
let selectedFile = null;
let selectedLfFile = null; 
let unsubscribe = null;
let lfUnsubscribe = null;
let selectedSocialLocation = null;
let globalResults = []; // Cache for global search results

// --- GLOBAL VARIABLES ---
let currentUserDisplayName = ""; 
let currentUserFullName = "";  
let currentUserId = null;
let isAdmin = false; 

// ---------------- AUTHENTICATION LOGIC ----------------

function checkAdminCredentials(name, pass) {
    return name === ADMIN_NAME && pass === ADMIN_PASS;
}

function getEmailFromName(name) {
    const cleanName = name.trim().replace(/\s+/g, ''); 
    return cleanName + "@school.local"; 
}

function updateGreeting(name, isAdmin) {
    const greetingElement = document.getElementById("user-greeting");
    let greeting = `×©×œ×•×, ${name}`; 
    
    if(isAdmin) {
         greeting = `×©×œ×•×, ${name} (×× ×”×œ) ğŸ‘‘`; 
    }
    greetingElement.innerText = greeting;
}

auth.onAuthStateChanged(user => {
    if (user) {
        currentUserId = user.uid;
        const simpleName = user.email.split('@')[0]; 
        currentUserDisplayName = simpleName;
        isAdmin = (simpleName === ADMIN_NAME); 

        const storedFullName = localStorage.getItem('fullUserName');
        let greetingName = storedFullName || simpleName; 
        currentUserFullName = greetingName;
        
        updateGreeting(greetingName, isAdmin);
        
        checkNewContentStatus('×–');
        checkNewContentStatus('×—');
        checkNewContentStatus('×˜');
        
        document.getElementById("view-login").classList.add("hidden");
        document.getElementById("view-grades").classList.remove("hidden");
    } else {
        currentUserId = null;
        isAdmin = false; 
        currentUserFullName = ""; 
        currentUserDisplayName = "";
        localStorage.removeItem('fullUserName'); 
        
        document.getElementById("view-login").classList.remove("hidden");
        document.getElementById("view-grades").classList.add("hidden");
        document.getElementById("view-subjects").classList.add("hidden");
        document.getElementById("view-form").classList.add("hidden");
        document.getElementById("view-sport-events").classList.add("hidden");
        document.getElementById("view-social-meeting").classList.add("hidden");
        document.getElementById("view-lost-found").classList.add("hidden");
        document.getElementById("view-global-search").classList.add("hidden");
    }
});


function handleRegister() {
    const name = document.getElementById("login-name").value.trim();
    const pass = document.getElementById("login-pass").value;
    const errorMsg = document.getElementById("login-error");

    if(!name || !pass) {
        errorMsg.innerText = "×× × ××œ× ×©× ×•×¡×™×¡××”";
        return;
    }
    if(pass.length < 6) {
        errorMsg.innerText = "×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 6 ×ª×•×•×™×";
        return;
    }
    if (name.toLowerCase() === ADMIN_NAME.toLowerCase()) {
        errorMsg.innerText = "×©× ×”××©×ª××© 'admin' ×©××•×¨ ×œ×× ×”×œ. ×× × ×‘×—×¨ ×©× ××—×¨.";
        return;
    }

    const email = getEmailFromName(name); 

    auth.createUserWithEmailAndPassword(email, pass)
        .then((userCredential) => {
            currentUserFullName = name; 
            localStorage.setItem('fullUserName', name); 
            localStorage.setItem(`lastViewed_×–`, Date.now());
            localStorage.setItem(`lastViewed_×—`, Date.now());
            localStorage.setItem(`lastViewed_×˜`, Date.now());
            
            updateGreeting(name, false); 
            errorMsg.innerText = "";
            alert("× ×¨×©××ª ×‘×”×¦×œ×—×”!");
        })
        .catch((error) => {
            console.error(error);
            if(error.code === "auth/email-already-in-use") {
                errorMsg.innerText = "×©× ×”××©×ª××© ×ª×¤×•×¡, × ×¡×” ×©× ××—×¨ ××• ×”×ª×—×‘×¨";
            } else {
                errorMsg.innerText = "×©×’×™××”: " + error.message;
            }
        });
}

function handleLogin() {
    const name = document.getElementById("login-name").value.trim();
    const pass = document.getElementById("login-pass").value;
    const errorMsg = document.getElementById("login-error");

    if(!name || !pass) {
        errorMsg.innerText = "×× × ××œ× ×©× ×•×¡×™×¡××”";
        return;
    }
    
    if (checkAdminCredentials(name, pass)) {
        auth.signInWithEmailAndPassword(getEmailFromName(ADMIN_NAME), pass)
            .then(() => {
                currentUserFullName = name; 
                localStorage.setItem('fullUserName', name); 
                updateGreeting(name, true); 
            })
            .catch((error) => {
                 errorMsg.innerText = "×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×";
            });
        return;
    }

    const email = getEmailFromName(name);

    auth.signInWithEmailAndPassword(email, pass)
        .then((userCredential) => {
             currentUserFullName = name; 
             localStorage.setItem('fullUserName', name); 
             updateGreeting(name, false); 
             errorMsg.innerText = "";
        })
        .catch((error) => {
            console.error(error);
            errorMsg.innerText = "×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×";
        });
}

function handleLogout() {
    localStorage.removeItem('fullUserName'); 
    auth.signOut();
}

// ---------------- NEW CONTENT INDICATION LOGIC ----------------

function removeBadge(element) {
    const badge = element.querySelector('.new-badge');
    if (badge) {
        badge.remove();
    }
}

function checkNewContentStatus(grade) {
    const lastViewed = parseInt(localStorage.getItem(`lastViewed_${grade}`) || 0);
    const gradeButton = document.getElementById(`grade-${grade.toLowerCase()}-btn`);

    if (!gradeButton || !currentUserId) return;

    let hasNewContent = false;
    let collectionsToCheck = [];

    defaultSubjects.forEach(sub => {
        collectionsToCheck.push(db.collection("grades").doc(grade).collection("subjects").doc(sub).collection("comments"));
    });
    
    collectionsToCheck.push(db.collection("grades").doc(grade).collection("sport_events"));
    collectionsToCheck.push(db.collection("grades").doc(grade).collection("social_meetings"));
    collectionsToCheck.push(db.collection("grades").doc(grade).collection("subjects").doc("×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ××• ×‘×§×©×•×ª").collection("comments"));

    removeBadge(gradeButton); 

    const checkCollection = (index) => {
        if (hasNewContent || index >= collectionsToCheck.length) {
            if (hasNewContent) {
                gradeButton.innerHTML += '<span class="new-badge">!</span>';
            }
            return;
        }

        collectionsToCheck[index].orderBy("timestamp", "desc").limit(1).get()
            .then(snapshot => {
                if (!snapshot.empty) {
                    const latestTimestampObj = snapshot.docs[0].data().timestamp;
                    
                    if (latestTimestampObj && typeof latestTimestampObj.toMillis === 'function') {
                        const latestTimestamp = latestTimestampObj.toMillis();
                        if (latestTimestamp > lastViewed) {
                            hasNewContent = true;
                        }
                    }
                }
                checkCollection(index + 1);
            })
            .catch(error => {
                console.error(`Error checking collection ${index}:`, error.message);
                checkCollection(index + 1);
            });
    };

    checkCollection(0);
}

function setGradeLastViewed(grade) {
    localStorage.setItem(`lastViewed_${grade}`, Date.now());
    checkNewContentStatus('×–');
    checkNewContentStatus('×—');
    checkNewContentStatus('×˜');
}

// ---------------- GLOBAL SEARCH LOGIC ----------------

function openGlobalSearch() {
    document.getElementById("view-grades").classList.add("hidden");
    document.getElementById("view-global-search").classList.remove("hidden");
    document.getElementById("search-global").value = "";
    document.getElementById("global-results-list").innerHTML = '<p>×˜×•×¢×Ÿ ×ª×•×¦××•×ª ×¨××©×•× ×™×•×ª...</p>';
    
    loadGlobalData();
}

async function loadGlobalData() {
    globalResults = [];
    const gradePromises = [];

    GRADES.forEach(grade => {
        // 1. Subject Comments (including "×”×¦×¢×•×ª ×œ×©×™×¤×•×¨...")
        ALL_SUBJECTS.forEach(subject => {
            const commentsRef = db.collection("grades").doc(grade)
                                  .collection("subjects").doc(subject)
                                  .collection("comments").orderBy("timestamp", "desc");
            gradePromises.push(commentsRef.get().then(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    globalResults.push({
                        type: 'comment',
                        grade,
                        context: subject,
                        text: data.description,
                        user: data.comment,
                        timestamp: data.timestamp
                    });
                });
            }).catch(e => console.log(`Error loading comments for ${grade}/${subject}:`, e.message)));
        });

        // 2. Sport Events
        const sportRef = db.collection("grades").doc(grade).collection("sport_events").orderBy("timestamp", "desc");
        gradePromises.push(sportRef.get().then(snapshot => {
            snapshot.forEach(doc => {
                const data = doc.data();
                globalResults.push({
                    type: 'sport',
                    grade,
                    context: data.name,
                    text: `××™×¨×•×¢: ${data.name}, ×ª××¨×™×š: ${data.date} ×©×¢×”: ${data.time}`,
                    user: data.creator,
                    timestamp: data.timestamp
                });
            });
        }).catch(e => console.log(`Error loading sport for ${grade}:`, e.message)));

        // 3. Social Meetings
        const socialRef = db.collection("grades").doc(grade).collection("social_meetings").orderBy("timestamp", "desc");
        gradePromises.push(socialRef.get().then(snapshot => {
            snapshot.forEach(doc => {
                const data = doc.data();
                globalResults.push({
                    type: 'social',
                    grade,
                    context: data.location,
                    text: `××¤×’×©: ${data.location}, ×ª××¨×™×š: ${data.date} ×©×¢×”: ${data.time}`,
                    user: data.creator,
                    timestamp: data.timestamp
                });
            });
        }).catch(e => console.log(`Error loading social for ${grade}:`, e.message)));
    });

    await Promise.all(gradePromises);
    
    // Sort results by timestamp (newest first)
    globalResults.sort((a, b) => {
        const timeA = a.timestamp && typeof a.timestamp.toMillis === 'function' ? a.timestamp.toMillis() : 0;
        const timeB = b.timestamp && typeof b.timestamp.toMillis === 'function' ? b.timestamp.toMillis() : 0;
        return timeB - timeA;
    });

    renderGlobalResults(globalResults);
}

function renderGlobalResults(results) {
    const list = document.getElementById("global-results-list");
    list.innerHTML = "";

    if (results.length === 0) {
        list.innerHTML = "<p>×œ× × ××¦××• ×ª×•×¦××•×ª ×ª×•×××•×ª.</p>";
        return;
    }

    results.forEach(item => {
        const div = document.createElement("div");
        div.className = "global-result";
        
        let typeIcon = '';
        if (item.type === 'comment') typeIcon = 'ğŸ’¬ ×”×¢×¨×”';
        else if (item.type === 'sport') typeIcon = 'âš½ ××™×¨×•×¢ ×¡×¤×•×¨×˜';
        else if (item.type === 'social') typeIcon = 'ğŸ«‚ ××¤×’×© ×—×‘×¨×ª×™';
        
        const timestampStr = item.timestamp 
            ? new Date(item.timestamp.toMillis()).toLocaleString('he-IL', { dateStyle: 'short', timeStyle: 'short' })
            : '×œ×œ× ×ª××¨×™×š';

        div.innerHTML = `
            <h4>${typeIcon} (${item.grade}) - ${item.context}</h4>
            <p>${item.text}</p>
            <small style="display:block; margin-top: 5px;">×¤×•×¨×¡× ×¢"×™: ${item.user} | ×‘: ${timestampStr}</small>
        `;
        list.appendChild(div);
    });
}

function filterGlobalItems(filter) {
    const lowerCaseFilter = filter.toLowerCase().trim();
    
    if (lowerCaseFilter === "") {
        renderGlobalResults(globalResults); // Show all cached results
        return;
    }

    const filtered = globalResults.filter(item => {
        // Search across content, context (subject/event name), and user name
        const textToSearch = `${item.text} ${item.context} ${item.user} ${item.grade}`.toLowerCase();
        return textToSearch.includes(lowerCaseFilter);
    });

    renderGlobalResults(filtered);
}

// ---------------- NAVIGATION LOGIC ----------------

function openGrade(grade) {
  currentGrade = grade;
  setGradeLastViewed(grade); 
  document.getElementById("view-grades").classList.add("hidden");
  document.getElementById("view-lost-found").classList.add("hidden");
  document.getElementById("view-global-search").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
  document.getElementById("subject-title").innerText = "××§×¦×•×¢×•×ª ×‘×©×›×‘×ª " + grade;
  
  const subjectList = document.getElementById("subject-list");
  subjectList.innerHTML = "";
  defaultSubjects.forEach(sub => {
    const btn = document.createElement("button");
    btn.innerText = sub;
    btn.onclick = () => openForm(sub);
    subjectList.appendChild(btn);
  });

  const catList = document.getElementById("category-list");
  catList.innerHTML = "";
  extraCategories.forEach(cat => {
    const btn = document.createElement("button");
    btn.innerText = cat;
    if(cat === "×¡×¤×•×¨×˜") btn.onclick = openSportEvents;
    else if(cat === "××¤×’×© ×—×‘×¨×ª×™") btn.onclick = openSocialMeeting;
    else btn.onclick = () => openForm(cat);
    catList.appendChild(btn);
  });
}

function backToGrades() {
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("view-lost-found").classList.add("hidden");
  document.getElementById("view-global-search").classList.add("hidden");
  document.getElementById("view-grades").classList.remove("hidden");
  
  checkNewContentStatus('×–');
  checkNewContentStatus('×—');
  checkNewContentStatus('×˜');
}

function backToSubjects() {
  document.getElementById("view-form").classList.add("hidden");
  document.getElementById("view-sport-events").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.add("hidden");
  document.getElementById("social-datetime").classList.add("hidden");
  document.getElementById("view-subjects").classList.remove("hidden");
}

// ---------------- IMAGE UPLOAD HANDLING ----------------

document.getElementById("imageInput").addEventListener("change", e => {
  selectedFile = e.target.files[0];
  const cancelBtn = document.getElementById("cancelImageBtn");
  const preview = document.getElementById("preview");

  if(selectedFile){
    cancelBtn.classList.remove("hidden");
    const reader = new FileReader();
    reader.onload = e2 => {
      preview.src = e2.target.result;
      preview.classList.remove("hidden");
    };
    reader.readAsDataURL(selectedFile);
  } else cancelImage();
});

function cancelImage(){
  selectedFile = null;
  const input = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  input.value = "";
  preview.src = "";
  preview.classList.add("hidden");
  document.getElementById("cancelImageBtn").classList.add("hidden");
}

// Separate logic for Lost & Found Image
document.getElementById("lfImageInput").addEventListener("change", e => {
  selectedLfFile = e.target.files[0];
  const cancelBtn = document.getElementById("cancelLfImageBtn");
  const preview = document.getElementById("lf-preview");

  if(selectedLfFile){
    cancelBtn.classList.remove("hidden");
    const reader = new FileReader();
    reader.onload = e2 => {
      preview.src = e2.target.result;
      preview.classList.remove("hidden");
    };
    reader.readAsDataURL(selectedLfFile);
  } else cancelLfImage();
});

function cancelLfImage(){
  selectedLfFile = null;
  const input = document.getElementById("lfImageInput");
  const preview = document.getElementById("lf-preview");
  input.value = "";
  preview.src = "";
  preview.classList.add("hidden");
  document.getElementById("cancelLfImageBtn").classList.add("hidden");
}

// ---------------- SUBJECT COMMENTS & LIKES ----------------

function openForm(subject) {
  currentSubject = subject;
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-form").classList.remove("hidden");
  document.getElementById("form-title").innerText = "×”×•×¡×¤×ª ×”×¢×¨×” ×œ: " + subject;
  
  document.getElementById("comment").value = currentUserFullName; 
  
  document.getElementById("description").value = "";
  cancelImage();
  loadNotes();
}

async function saveSubject(parentCommentId = null) {
  const description = document.getElementById("description").value.trim();
  const commentUserName = currentUserFullName;
  
  if(!description){ alert("×× × ×›×ª×•×‘ ×ª×™××•×¨"); return; }

  try {
    let imageUrl = "";
    if(selectedFile){
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`${currentGrade}/${currentSubject}/${Date.now()}-${selectedFile.name}`);
      await fileRef.put(selectedFile);
      imageUrl = await fileRef.getDownloadURL();
    }

    const subjectRef = db.collection("grades").doc(currentGrade)
                          .collection("subjects").doc(currentSubject);
    await subjectRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

    const dataPayload = {
        comment: commentUserName, 
        description: description,
        imageUrl: imageUrl || "",
        user: currentUserFullName, 
        userId: currentUserId,
        likes: [], 
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    if(parentCommentId){
      await subjectRef.collection("comments").doc(parentCommentId)
        .collection("replies").add(dataPayload);
    } else {
      await subjectRef.collection("comments").add(dataPayload);
    }

    alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
    document.getElementById("description").value = "";
    cancelImage();
    
    setGradeLastViewed(currentGrade); 

  } catch(err){
    console.error("Upload error:", err);
    alert("×©×’×™××” ×‘×©××™×¨×”: "+err.message);
  }
}

function loadNotes() {
  const list = document.getElementById("notes-list");
  const ref = db.collection("grades").doc(currentGrade)
    .collection("subjects").doc(currentSubject)
    .collection("comments").orderBy("timestamp","desc");

  if(unsubscribe) unsubscribe();
  unsubscribe = ref.onSnapshot(snapshot=>{
    list.innerHTML="";
    snapshot.forEach(doc=>{
      const note = doc.data();
      const div = document.createElement("div");
      div.className="note";
      div.innerHTML=`<h4>${note.comment}</h4><p>${note.description}</p>`+
                    (note.imageUrl ? `<img src="${note.imageUrl}">` : "");

      // Like Button
      const likes = note.likes || [];
      const isLiked = likes.includes(currentUserId);
      const likeBtn = document.createElement("button");
      likeBtn.innerHTML = isLiked ? `ğŸ‘ (${likes.length})` : `ğŸ¤ (${likes.length})`;
      likeBtn.style.background = isLiked ? "#388e3c" : "#1976d2"; 
      likeBtn.onclick = () => toggleLike(doc.ref, isLiked);
      div.appendChild(likeBtn);

      // Reply button
      const replyBtn = document.createElement("button");
      replyBtn.innerText = "ğŸ’¬ ×”×©×‘";
      replyBtn.onclick = ()=> {
        const replyDesc = prompt("×›×ª×•×‘ ×ª×’×•×‘×”:");
        if(replyDesc){
          saveSubjectReply(doc.id, replyDesc); 
        }
      };
      div.appendChild(replyBtn);

      // Delete button
      const deleteBtn = document.createElement("button");
      deleteBtn.innerText = "ğŸ—‘ï¸ ××—×§";
      deleteBtn.style.background = "#d32f2f";
      deleteBtn.style.marginLeft = "0px";
      deleteBtn.onclick = async () => {
        if(confirm("×œ××—×•×§ ×”×¢×¨×” ×–×•?")) {
          await doc.ref.delete();
        }
      };
      
      if (isAdmin || note.userId === currentUserId) { 
          div.appendChild(deleteBtn);
      }

      // Load replies
      doc.ref.collection("replies").orderBy("timestamp","asc").onSnapshot(replySnap=>{
        const oldReplies = div.querySelectorAll(".reply");
        oldReplies.forEach(r => r.remove());
        replySnap.forEach(replyDoc=>{
          const r = replyDoc.data();
          const rDiv = document.createElement("div");
          rDiv.className="reply";
          rDiv.innerHTML=`<strong>${r.comment}</strong><p>${r.description}</p>`+
                           (r.imageUrl ? `<img src="${r.imageUrl}">` : "");

          const delReplyBtn = document.createElement("button");
          delReplyBtn.innerText = "ğŸ—‘ï¸ ××—×§";
          delReplyBtn.style.background = "#d32f2f";
          delReplyBtn.style.marginLeft = "4px";
          delReplyBtn.onclick = async () => {
            if(confirm("×œ××—×•×§ ×ª×’×•×‘×” ×–×•?")) {
              await replyDoc.ref.delete();
            }
          };
          
          if (isAdmin || r.userId === currentUserId) { 
              rDiv.appendChild(delReplyBtn);
          }

          div.appendChild(rDiv);
        });
      });

      list.appendChild(div);
    });
  });
}

function toggleLike(docRef, isLiked) {
    if (isLiked) {
        docRef.update({
            likes: firebase.firestore.FieldValue.arrayRemove(currentUserId)
        });
    } else {
        docRef.update({
            likes: firebase.firestore.FieldValue.arrayUnion(currentUserId)
        });
    }
}

async function saveSubjectReply(parentCommentId, description){ 
  const subjectRef = db.collection("grades").doc(currentGrade)
                        .collection("subjects").doc(currentSubject);
  await subjectRef.collection("comments").doc(parentCommentId)
    .collection("replies").add({
      comment: currentUserFullName, 
      description,
      user: currentUserFullName, 
      userId: currentUserId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    setGradeLastViewed(currentGrade); 
}

// ---------------- GLOBAL LOST & FOUND ----------------

function openLostAndFound() {
    document.getElementById("view-grades").classList.add("hidden");
    document.getElementById("view-global-search").classList.add("hidden");
    document.getElementById("view-lost-found").classList.remove("hidden");
    document.getElementById("lf-comment").value = currentUserFullName;
    document.getElementById("lf-description").value = "";
    cancelLfImage();
    loadLostItems();
}

async function saveLostItem() {
    const description = document.getElementById("lf-description").value.trim();
    if(!description){ alert("×× × ×›×ª×•×‘ ×ª×™××•×¨"); return; }
    
    try {
        let imageUrl = "";
        if(selectedLfFile){
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`global/lost_and_found/${Date.now()}-${selectedLfFile.name}`);
            await fileRef.put(selectedLfFile);
            imageUrl = await fileRef.getDownloadURL();
        }
        
        await db.collection("global").doc("lost_and_found").collection("items").add({
            description: description,
            imageUrl: imageUrl || "",
            user: currentUserFullName,
            userId: currentUserId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert("×”××•×“×¢×” ×¤×•×¨×¡××”!");
        document.getElementById("lf-description").value = "";
        cancelLfImage();
        
    } catch(err) {
        console.error(err);
        alert("×©×’×™××”: " + err.message);
    }
}

function loadLostItems() {
    const list = document.getElementById("lf-list");
    const ref = db.collection("global").doc("lost_and_found").collection("items").orderBy("timestamp", "desc");
    
    if(lfUnsubscribe) lfUnsubscribe();
    lfUnsubscribe = ref.onSnapshot(snapshot => {
        list.innerHTML = "";
        snapshot.forEach(doc => {
            const item = doc.data();
            const div = document.createElement("div");
            div.className = "lf-item";
            div.innerHTML = `<h4>×¤×•×¨×¡× ×¢"×™: ${item.user}</h4><p>${item.description}</p>` +
                            (item.imageUrl ? `<img src="${item.imageUrl}">` : "");

            // Reply/Comment logic for Lost & Found
            const replyBtn = document.createElement("button");
            replyBtn.innerText = "ğŸ’¬ ×”×’×‘";
            replyBtn.onclick = () => {
                const replyText = prompt("×›×ª×•×‘ ×ª×’×•×‘×”:");
                if(replyText) {
                    doc.ref.collection("comments").add({
                        user: currentUserFullName,
                        text: replyText,
                        userId: currentUserId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            };
            div.appendChild(replyBtn);

            // Delete button
            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "ğŸ—‘ï¸ ××—×§";
            deleteBtn.style.background = "#d32f2f";
            deleteBtn.onclick = async () => {
                if(confirm("×œ××—×•×§ ××•×“×¢×” ×–×•?")) await doc.ref.delete();
            };
            if(isAdmin || item.userId === currentUserId) div.appendChild(deleteBtn);

            // Load comments for this item
            doc.ref.collection("comments").orderBy("timestamp", "asc").onSnapshot(cSnap => {
                const oldComments = div.querySelectorAll(".reply");
                oldComments.forEach(c => c.remove());
                
                cSnap.forEach(cDoc => {
                    const cData = cDoc.data();
                    const cDiv = document.createElement("div");
                    cDiv.className = "reply";
                    cDiv.innerHTML = `<strong>${cData.user}</strong>: ${cData.text}`;
                    
                    const delCBtn = document.createElement("button");
                    delCBtn.innerText = "ğŸ—‘ï¸";
                    delCBtn.style.background = "#d32f2f";
                    delCBtn.style.fontSize = "1rem";
                    delCBtn.style.padding = "2px 6px";
                    delCBtn.onclick = async () => {
                        if(confirm("×œ××—×•×§ ×ª×’×•×‘×”?")) await cDoc.ref.delete();
                    };
                    if(isAdmin || cData.userId === currentUserId) cDiv.appendChild(delCBtn);
                    
                    div.appendChild(cDiv);
                });
            });

            list.appendChild(div);
        });
    });
}


// ---------------- EVENT COMMENTS LOGIC (Sport & Social) ----------------

function renderEventComments(docRef, containerDiv) {
    containerDiv.innerHTML = ""; // Clear
    
    const inputDiv = document.createElement("div");
    inputDiv.style.marginBottom = "10px";
    
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "×›×ª×•×‘ ×ª×’×•×‘×” ×œ××™×¨×•×¢...";
    input.style.width = "70%";
    input.style.display = "inline-block";
    
    const sendBtn = document.createElement("button");
    sendBtn.innerText = "×©×œ×—";
    sendBtn.style.width = "25%";
    sendBtn.style.fontSize = "1.2rem";
    sendBtn.onclick = () => {
        const text = input.value.trim();
        if(text) {
            docRef.collection("comments").add({
                user: currentUserFullName,
                userId: currentUserId,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }
    };
    
    inputDiv.appendChild(input);
    inputDiv.appendChild(sendBtn);
    containerDiv.appendChild(inputDiv);
    
    const commentsList = document.createElement("div");
    containerDiv.appendChild(commentsList);
    
    docRef.collection("comments").orderBy("timestamp", "asc").onSnapshot(snap => {
        commentsList.innerHTML = "";
        snap.forEach(cDoc => {
            const cData = cDoc.data();
            const cDiv = document.createElement("div");
            cDiv.className = "reply"; 
            cDiv.innerHTML = `<strong>${cData.user}</strong>: ${cData.text}`;
            
            const delBtn = document.createElement("button");
            delBtn.innerText = "ğŸ—‘ï¸";
            delBtn.style.background = "#d32f2f";
            delBtn.style.fontSize = "1rem";
            delBtn.style.padding = "2px 6px";
            delBtn.onclick = async () => { if(confirm("×œ××—×•×§?")) await cDoc.ref.delete(); };
            
            if(isAdmin || cData.userId === currentUserId) cDiv.appendChild(delBtn);
            
            commentsList.appendChild(cDiv);
        });
    });
}

// ---------------- SPORT EVENTS ----------------

function openSportEvents(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-sport-events").classList.remove("hidden");
  loadSportEvents();
}

function saveSportEvent(){
  const eventName = document.getElementById("sport-event-select").value;
  const date = document.getElementById("sport-date").value;
  const time = document.getElementById("sport-time").value;
  if(!date || !time){ alert("×× × ×‘×—×¨ ×ª××¨×™×š ×•×©×¢×”"); return; }
  db.collection("grades").doc(currentGrade)
    .collection("sport_events").add({
      name: eventName,
      date,
      time,
      creator: currentUserFullName, 
      userId: currentUserId,
      attendees: [], 
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=> {
        loadSportEvents();
        setGradeLastViewed(currentGrade); 
    });
}

function loadSportEvents(){
  const list = document.getElementById("sport-events-list");
  list.innerHTML = "";
  db.collection("grades").doc(currentGrade)
    .collection("sport_events").orderBy("timestamp","desc")
    .onSnapshot(snapshot=>{
      list.innerHTML = "";
      snapshot.forEach(doc=>{
        const e = doc.data();
        const div = document.createElement("div");
        div.className="event";
        div.innerHTML = `<strong>${e.name}</strong><br>${e.date} ${e.time}<br><small>× ×§×‘×¢ ×¢"×™: ${e.creator || '?'}</small>`;

        // Attendance
        const attendees = e.attendees || [];
        const myAttendanceIndex = attendees.findIndex(a => a.uid === currentUserId);
        const isAttending = myAttendanceIndex !== -1;

        const attendBtn = document.createElement("button");
        attendBtn.innerText = isAttending ? "âŒ ×‘×˜×œ ×”×’×¢×”" : "âœ‹ ×× ×™ ××’×™×¢";
        attendBtn.style.background = isAttending ? "#f57c00" : "#43a047";
        attendBtn.style.marginRight = "10px";
        attendBtn.onclick = () => toggleAttendance(doc.ref, attendees, isAttending);
        div.appendChild(attendBtn);

        if(attendees.length > 0) {
            const names = attendees.map(a => a.name).join(", ");
            const attendeesDiv = document.createElement("div");
            attendeesDiv.className = "attendees-list";
            attendeesDiv.innerText = "××’×™×¢×™×: " + names;
            div.appendChild(attendeesDiv);
        }

        // --- NEW EVENT COMMENTS ---
        const commentToggleBtn = document.createElement("button");
        commentToggleBtn.innerText = "ğŸ’¬ ×ª×’×•×‘×•×ª";
        commentToggleBtn.style.background = "#607d8b";
        
        const commentsSection = document.createElement("div");
        commentsSection.className = "event-comments-section";
        
        let commentsLoaded = false;
        commentToggleBtn.onclick = () => {
             commentsSection.classList.toggle("open");
             if(!commentsLoaded && commentsSection.classList.contains("open")) {
                 renderEventComments(doc.ref, commentsSection);
                 commentsLoaded = true;
             }
        };
        
        div.appendChild(commentToggleBtn);
        div.appendChild(commentsSection);
        // --------------------------

        const delBtn = document.createElement("button");
        delBtn.innerText = "ğŸ—‘ï¸ ××—×§ ××™×¨×•×¢";
        delBtn.style.background = "#d32f2f";
        delBtn.style.marginLeft = "4px";
        delBtn.onclick = async () => {
          if(confirm("×œ××—×•×§ ××™×¨×•×¢ ×–×”?")) {
            await doc.ref.delete();
          }
        };
        
        if (isAdmin || e.userId === currentUserId) { 
            div.appendChild(delBtn);
        }

        list.appendChild(div);
      });
    });
}

function toggleAttendance(docRef, currentAttendees, isAttending) {
    let newAttendees = [...currentAttendees];
    if (isAttending) {
        newAttendees = newAttendees.filter(a => a.uid !== currentUserId);
    } else {
        newAttendees.push({ uid: currentUserId, name: currentUserFullName });
    }
    docRef.update({ attendees: newAttendees });
}

// ---------------- SOCIAL MEETINGS ----------------

function openSocialMeeting(){
  document.getElementById("view-subjects").classList.add("hidden");
  document.getElementById("view-social-meeting").classList.remove("hidden");
  document.getElementById("social-datetime").classList.add("hidden");
  loadSocialMeetings();
}

function selectSocialLocation(location){
  selectedSocialLocation = location;
  document.getElementById("selected-location").innerText = location;
  document.getElementById("social-datetime").classList.remove("hidden");
}

function saveSocialMeeting(){
  const date = document.getElementById("social-date").value;
  const time = document.getElementById("social-time").value;
  if(!selectedSocialLocation || !date || !time){ alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª"); return; }
  db.collection("grades").doc(currentGrade)
    .collection("social_meetings").add({
      location: selectedSocialLocation,
      date,
      time,
      creator: currentUserFullName, 
      userId: currentUserId,
      attendees: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=> {
        loadSocialMeetings();
        setGradeLastViewed(currentGrade); 
    });
}

function loadSocialMeetings(){
  const list = document.getElementById("social-meetings-list");
  list.innerHTML = "";
  db.collection("grades").doc(currentGrade)
    .collection("social_meetings").orderBy("timestamp","desc")
    .onSnapshot(snapshot=>{
      list.innerHTML = "";
      snapshot.forEach(doc=>{
        const e = doc.data();
        const div = document.createElement("div");
        div.className="social";
        div.innerHTML = `<strong>${e.location}</strong><br>${e.date} ${e.time}<br><small>× ×§×‘×¢ ×¢"×™: ${e.creator || '?'}</small>`;

        // Attendance
        const attendees = e.attendees || [];
        const myAttendanceIndex = attendees.findIndex(a => a.uid === currentUserId);
        const isAttending = myAttendanceIndex !== -1;

        const attendBtn = document.createElement("button");
        attendBtn.innerText = isAttending ? "âŒ ×‘×˜×œ ×”×’×¢×”" : "âœ‹ ×× ×™ ××’×™×¢";
        attendBtn.style.background = isAttending ? "#f57c00" : "#43a047";
        attendBtn.style.marginRight = "10px";
        attendBtn.onclick = () => toggleAttendance(doc.ref, attendees, isAttending);
        div.appendChild(attendBtn);

        if(attendees.length > 0) {
            const names = attendees.map(a => a.name).join(", ");
            const attendeesDiv = document.createElement("div");
            attendeesDiv.className = "attendees-list";
            attendeesDiv.innerText = "××’×™×¢×™×: " + names;
            div.appendChild(attendeesDiv);
        }

        // --- NEW EVENT COMMENTS ---
        const commentToggleBtn = document.createElement("button");
        commentToggleBtn.innerText = "ğŸ’¬ ×ª×’×•×‘×•×ª";
        commentToggleBtn.style.background = "#607d8b";
        
        const commentsSection = document.createElement("div");
        commentsSection.className = "event-comments-section";
        
        let commentsLoaded = false;
        commentToggleBtn.onclick = () => {
             commentsSection.classList.toggle("open");
             if(!commentsLoaded && commentsSection.classList.contains("open")) {
                 renderEventComments(doc.ref, commentsSection);
                 commentsLoaded = true;
             }
        };
        
        div.appendChild(commentToggleBtn);
        div.appendChild(commentsSection);
        // --------------------------

        const delBtn = document.createElement("button");
        delBtn.innerText = "ğŸ—‘ï¸ ××—×§ ××™×¨×•×¢";
        delBtn.style.background = "#d32f2f";
        delBtn.style.marginLeft = "4px";
        delBtn.onclick = async () => {
          if(confirm("×œ××—×•×§ ××¤×’×© ×–×”?")) {
            await doc.ref.delete();
          }
        };
        
        if (isAdmin || e.userId === currentUserId) { 
            div.appendChild(delBtn);
        }

        list.appendChild(div);
      });
    });
}
</script>
</body>
</html>
